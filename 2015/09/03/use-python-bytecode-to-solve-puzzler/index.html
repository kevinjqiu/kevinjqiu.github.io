
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Use Python bytecode to solve puzzler - Qiu&#8217;s Quibble</title>
  <meta name="author" content="Kevin Jing Qiu">

  
  <meta name="description" content="Learning Python Internals Recently I stumbled upon this wonderful set of videos on Python interpreter internals. (Thanks to Philip Guo for creating &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://kevinjqiu.github.io/2015/09/03/use-python-bytecode-to-solve-puzzler">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Qiu's Quibble" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href='http://fonts.googleapis.com/css?family=Quattrocento+Sans|Roboto:400,300' rel='stylesheet' type='text/css'>

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-32737230-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>


<body>
	<div class="container">
		<aside class="left">
			<div class="inner-left">
				<header>
					
  <img src="http://www.gravatar.com/avatar/696a8f13a7fcf0b4265fe801f18ba7b5?s=200" alt="Gravatar of Kevin Jing Qiu " title="Gravatar of Kevin Jing Qiu" class="profilepic" />

<hgroup>
  <h1><a href="/">Qiu&#8217;s Quibble</a></h1>
  
    <h2 class="subtitle">A blog about nothing and everything</h2>
   
</hgroup>

<section>
  <p style="color:white">I&#8217;m a software developer living in the Greater Toronto Area, Canada. My favourite programming language is Python while I admire the beauty of Clojure and Scala. I use console vim with tmux for most of my coding, and I use Arch Linux at home and Ubuntu at work.
  </p>
</section>


				</header>
				<footer>
					<p>
	
		<a href="http://github.com/kevinjqiu" class="btn btn-dark">GitHub</a>
	
	
		<a href="http://twitter.com/kevinjqiu" class="btn btn-dark">Twitter</a>
	
</p>
				</footer>
			</div>
		</aside>
    	<section class="right">
    		<div class="inner-right">
    			<div id="posts">
    			  	<article class="post">
    
  <header>
    
      <h1 class="entry-title">Use Python Bytecode to Solve Puzzler</h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-09-03T22:16:36-04:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


<div class="entry-content"><h2>Learning Python Internals</h2>

<p>Recently I stumbled upon <a href="https://www.youtube.com/playlist?list=PLwyG5wA5gIzgTFj5KgJJ15lxq5Cv6lo_0">this wonderful set of videos on Python interpreter internals</a>. (Thanks to <a href="http://pgbovine.net/">Philip Guo</a> for creating them and thanks to Michael Kennedy (@mkennedy) and his <a href="http://talkpython.fm/">Talk Python to me</a> show that brought this on my radar)</p>

<p>I&rsquo;ve been using Python for about ten years but I&rsquo;ve never really truly been able to understand how the interpreter works, nor was I familiar with the Python virtual machine or the bytecode. These videos may just be the extra help I needed to get me started at the internals of Python.</p>

<p>So far, I&rsquo;ve only watched 2 lectures and I&rsquo;m already learning a lot. I learned where to find a list of opcodes in the source code, where the main eval loop is, and what internal states the Python virtual machine keeps.</p>

<p>Then I thought to myself, why not use this new found power to solve some Python mysterious that have been puzzling me?</p>

<h2>The puzzler</h2>

<p>A few days ago, one of my former co-workers posted this puzzler:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">b</span><span class="p">]</span> <span class="o">=</span> <span class="p">{},</span> <span class="mi">5</span>
</span></code></pre></td></tr></table></div></figure>


<p>What are the values of <code>a</code> and <code>b</code> after the assignment? Well, it&rsquo;s not obvious what the order of assignment it is going to be. Putting it in the REPL gives us this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">b</span><span class="p">]</span> <span class="o">=</span> <span class="p">{},</span> <span class="mi">5</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">a</span>
</span><span class='line'><span class="p">{</span><span class="mi">5</span><span class="p">:</span> <span class="p">({</span><span class="o">...</span><span class="p">},</span> <span class="mi">5</span><span class="p">)}</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">a</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
</span><span class='line'><span class="p">({</span><span class="mi">5</span><span class="p">:</span> <span class="p">({</span><span class="o">...</span><span class="p">},</span> <span class="mi">5</span><span class="p">)},</span> <span class="mi">5</span><span class="p">)</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">a</span><span class="p">[</span><span class="mi">5</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</span><span class='line'><span class="p">{</span><span class="mi">5</span><span class="p">:</span> <span class="p">({</span><span class="o">...</span><span class="p">},</span> <span class="mi">5</span><span class="p">)}</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">a</span><span class="p">[</span><span class="mi">5</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">5</span><span class="p">]</span>
</span><span class='line'><span class="p">({</span><span class="mi">5</span><span class="p">:</span> <span class="p">({</span><span class="o">...</span><span class="p">},</span> <span class="mi">5</span><span class="p">)},</span> <span class="mi">5</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>OK, so there appears to be a circular reference going on here. The object that <code>a</code> refers to has an element that refers to the object that <code>a</code> refers to and so on and so forth. Now, the question is, how did the circular reference get there?</p>

<p>Well, all Python source code eventually get compiled down to bytecode and executed on the virtual machine. In order to understand what that line actually does, we need to look at the byte code.</p>

<p>It turns out that Python comes with a module to disassemble source code into byte codes (assembly for the virtual machine):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="err">$</span> <span class="n">python</span> <span class="o">-</span><span class="n">m</span> <span class="n">dis</span>
</span><span class='line'><span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">{},</span> <span class="mi">5</span>
</span><span class='line'><span class="o">^</span><span class="n">D</span>
</span><span class='line'>  <span class="mi">1</span>           <span class="mi">0</span> <span class="n">BUILD_MAP</span>                <span class="mi">0</span>
</span><span class='line'>              <span class="mi">3</span> <span class="n">LOAD_CONST</span>               <span class="mi">0</span> <span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</span><span class='line'>              <span class="mi">6</span> <span class="n">BUILD_TUPLE</span>              <span class="mi">2</span>
</span><span class='line'>              <span class="mi">9</span> <span class="n">DUP_TOP</span>
</span><span class='line'>             <span class="mi">10</span> <span class="n">UNPACK_SEQUENCE</span>          <span class="mi">2</span>
</span><span class='line'>             <span class="mi">13</span> <span class="n">STORE_NAME</span>               <span class="mi">0</span> <span class="p">(</span><span class="n">a</span><span class="p">)</span>
</span><span class='line'>             <span class="mi">16</span> <span class="n">STORE_NAME</span>               <span class="mi">1</span> <span class="p">(</span><span class="n">b</span><span class="p">)</span>
</span><span class='line'>             <span class="mi">19</span> <span class="n">LOAD_NAME</span>                <span class="mi">0</span> <span class="p">(</span><span class="n">a</span><span class="p">)</span>
</span><span class='line'>             <span class="mi">22</span> <span class="n">LOAD_CONST</span>               <span class="mi">0</span> <span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</span><span class='line'>             <span class="mi">25</span> <span class="n">STORE_SUBSCR</span>
</span><span class='line'>             <span class="mi">26</span> <span class="n">LOAD_CONST</span>               <span class="mi">1</span> <span class="p">(</span><span class="bp">None</span><span class="p">)</span>
</span><span class='line'>             <span class="mi">29</span> <span class="n">RETURN_VALUE</span>
</span></code></pre></td></tr></table></div></figure>


<p>Alright, so that humble little line of code is actually 12 instructions for the Python virtual machine. Each instruction manipulates the virtual machine&rsquo;s internal state in some way. CPython is a stack-based interpreter, which means certain instructions puts values on the stack and other instructions consume them from the stack.</p>

<p>Let&rsquo;s go through the instructions:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="mi">0</span> <span class="n">BUILD_MAP</span>                <span class="mi">0</span>
</span></code></pre></td></tr></table></div></figure>


<p>First off, it tells the interpreter to make a map object and put it on the value stack. After this instruction, our value stack looks like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="o">+----+</span>
</span><span class='line'><span class="o">|</span> <span class="p">{}</span> <span class="o">|</span>
</span><span class='line'><span class="o">+----+</span>
</span></code></pre></td></tr></table></div></figure>


<p>Next up:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="mi">3</span> <span class="n">LOAD_CONST</span>               <span class="mi">0</span> <span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>This loads a constant (<code>5</code>) on the stack.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="o">+----+</span>
</span><span class='line'><span class="o">|</span> <span class="p">{}</span> <span class="o">|</span>
</span><span class='line'><span class="o">+----+</span>
</span><span class='line'><span class="o">|</span> <span class="mi">5</span>  <span class="o">|</span>
</span><span class='line'><span class="o">+----+</span>
</span></code></pre></td></tr></table></div></figure>


<p>Next:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="mi">6</span> <span class="n">BUILD_TUPLE</span>              <span class="mi">2</span>
</span></code></pre></td></tr></table></div></figure>


<p>This instruction builds a <code>PyTuple</code> object of size <code>2</code>, which is in the argument of the opcode. It consumes the top <code>2</code> things on the stack and make a 2-tuple using these values and put the result tuple on the value stack:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="o">+---------+</span>
</span><span class='line'><span class="o">|</span> <span class="p">({},</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span>
</span><span class='line'><span class="o">+---------+</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="mi">9</span> <span class="n">DUP_TOP</span>
</span></code></pre></td></tr></table></div></figure>


<p>Next we have the <code>DUP_TOP</code> instruction. It probably stands for &ldquo;duplicate the top of the stack&rdquo;, and reading the corresponding code in the eval loop, this seems to be what it&rsquo;s doing: it gets the object from the top of the stack without popping it off and push the value on the stack, while incrementing the refcount of the object.</p>

<p>It&rsquo;s worth noting that this only duplicates the tuple object. The elements inside the tuple are of type <code>*PyObject</code>, which are pointers to the corresponding values (the dict and the integer), and are not duplicated by this instruction. Here&rsquo;s the value stack after this instruction:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="o">+---------+</span>
</span><span class='line'><span class="o">|</span> <span class="p">({},</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span>
</span><span class='line'><span class="o">+---------+</span>
</span><span class='line'><span class="o">|</span> <span class="p">({},</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span>
</span><span class='line'><span class="o">+---------+</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="mi">10</span> <span class="n">UNPACK_SEQUENCE</span>          <span class="mi">2</span>
</span></code></pre></td></tr></table></div></figure>


<p>The next instruction is <code>UNPACK_SEQUENCE</code> with argument <code>2</code>. This will first pop the stack, so <code>({}, 5)</code> is off the stack, and then push each element from the tuple on the stack in reverse order. After this instruction, the stack will be:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="o">+---------+</span>
</span><span class='line'><span class="o">|</span> <span class="p">({},</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span>
</span><span class='line'><span class="o">+---------+</span>
</span><span class='line'><span class="o">|</span>   <span class="mi">5</span>     <span class="o">|</span>
</span><span class='line'><span class="o">+---------+</span>
</span><span class='line'><span class="o">|</span>   <span class="p">{}</span>    <span class="o">|</span>
</span><span class='line'><span class="o">+---------+</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="mi">13</span> <span class="n">STORE_NAME</span>               <span class="mi">0</span> <span class="p">(</span><span class="n">a</span><span class="p">)</span>
</span><span class='line'><span class="mi">16</span> <span class="n">STORE_NAME</span>               <span class="mi">1</span> <span class="p">(</span><span class="n">b</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>The next two instructions deal with &ldquo;names&rdquo;, which are variables for the scope of the frame. <code>STORE_NAME a</code> will pop the stack, and point <code>a</code> to the value, and similarily for <code>STORE_NAME b</code>. After this instruction, there will be two bindings in the frame: <code>a</code> and <code>b</code> and the stack will be back to having only one element, the tuple:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">stack</span><span class="p">:</span>
</span><span class='line'><span class="o">+---------+</span>
</span><span class='line'><span class="o">|</span> <span class="p">({},</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span>
</span><span class='line'><span class="o">+---------+</span>
</span><span class='line'>
</span><span class='line'><span class="n">bindings</span><span class="p">:</span>
</span><span class='line'><span class="n">a</span> <span class="o">&lt;-</span> <span class="p">{}</span>
</span><span class='line'><span class="n">b</span> <span class="o">&lt;-</span> <span class="mi">5</span>
</span></code></pre></td></tr></table></div></figure>


<p>The next two instructions:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="mi">19</span> <span class="n">LOAD_NAME</span>                <span class="mi">0</span> <span class="p">(</span><span class="n">a</span><span class="p">)</span>
</span><span class='line'><span class="mi">22</span> <span class="n">LOAD_CONST</span>               <span class="mi">0</span> <span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>LOAD_NAME a</code> will push the value that the variable is bound to on the stack, so:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">stack</span><span class="p">:</span>
</span><span class='line'><span class="o">+---------+</span>
</span><span class='line'><span class="o">|</span> <span class="p">({},</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span>
</span><span class='line'><span class="o">+---------+</span>
</span><span class='line'><span class="o">|</span>    <span class="p">{}</span>   <span class="o">|</span>
</span><span class='line'><span class="o">+---------+</span>
</span><span class='line'>
</span><span class='line'><span class="n">bindings</span><span class="p">:</span>
</span><span class='line'><span class="n">a</span> <span class="o">&lt;-</span> <span class="p">{}</span>
</span><span class='line'><span class="n">b</span> <span class="o">&lt;-</span> <span class="mi">5</span>
</span></code></pre></td></tr></table></div></figure>


<p>and <code>LOAD_CONST 5</code>, as we&rsquo;ve seen before, simply pushes the constant <code>5</code> on the stack:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">stack</span><span class="p">:</span>
</span><span class='line'><span class="o">+---------+</span>
</span><span class='line'><span class="o">|</span> <span class="p">({},</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span>
</span><span class='line'><span class="o">+---------+</span>
</span><span class='line'><span class="o">|</span>    <span class="p">{}</span>   <span class="o">|</span>
</span><span class='line'><span class="o">+---------+</span>
</span><span class='line'><span class="o">|</span>     <span class="mi">5</span>   <span class="o">|</span>
</span><span class='line'><span class="o">+---------+</span>
</span><span class='line'>
</span><span class='line'><span class="n">bindings</span><span class="p">:</span>
</span><span class='line'><span class="n">a</span> <span class="o">&lt;-</span> <span class="p">{}</span>
</span><span class='line'><span class="n">b</span> <span class="o">&lt;-</span> <span class="mi">5</span>
</span></code></pre></td></tr></table></div></figure>


<p>Finally:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="mi">25</span> <span class="n">STORE_SUBSCR</span>
</span></code></pre></td></tr></table></div></figure>


<p>This is where the magic happens. <code>STORE_SUBSCR</code> is an instruction to set element on the dictionary given the index. Here&rsquo;s the code that handles this opcode in the eval loop:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">TARGET_NOARG</span><span class="p">(</span><span class="n">STORE_SUBSCR</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">w</span> <span class="o">=</span> <span class="n">TOP</span><span class="p">();</span>
</span><span class='line'>    <span class="n">v</span> <span class="o">=</span> <span class="n">SECOND</span><span class="p">();</span>
</span><span class='line'>    <span class="n">u</span> <span class="o">=</span> <span class="n">THIRD</span><span class="p">();</span>
</span><span class='line'>    <span class="n">STACKADJ</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">);</span>
</span><span class='line'>    <span class="o">/*</span> <span class="n">v</span><span class="p">[</span><span class="n">w</span><span class="p">]</span> <span class="o">=</span> <span class="n">u</span> <span class="o">*/</span>
</span><span class='line'>    <span class="n">err</span> <span class="o">=</span> <span class="n">PyObject_SetItem</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">u</span><span class="p">);</span>
</span><span class='line'>    <span class="n">Py_DECREF</span><span class="p">(</span><span class="n">u</span><span class="p">);</span>
</span><span class='line'>    <span class="n">Py_DECREF</span><span class="p">(</span><span class="n">v</span><span class="p">);</span>
</span><span class='line'>    <span class="n">Py_DECREF</span><span class="p">(</span><span class="n">w</span><span class="p">);</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="n">DISPATCH</span><span class="p">();</span>
</span><span class='line'>    <span class="k">break</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here, <code>TOP</code>, <code>SECOND</code>, <code>THIRD</code> are macros that take values off of the value stack. Given our state of the virtual machine:
* <code>w = TOP()</code> => <code>w = 5</code>
* <code>v = SECOND()</code> => <code>v = {}</code>
* <code>w = THIRD()</code> => <code>w = ({}, 5)</code>, but keep in mind, the first element in <code>w</code> (the tuple) is actually the same object <code>v</code> is pointing to.</p>

<p>Thus, calling <code>PyObject_SetItem(v, w, u)</code> sets <code>v[w] = u</code> => <code>v[5] = (v, 5)</code>, and there a circular reference is born!</p>

<p>From the sequence of operation, we can tell the order by which the assignments were executed:
1. <code>a, b = {}, 5</code>
2. <code>a[5] = ({}, 5)</code>, with <code>a</code> refering to the dictionary</p>

<h2>Conclusion</h2>

<p>Diving into the Python implementation is the next level ninjary that may come in handy in some cases. Granted, no one is going to write production code like the one in the puzzler, but stepping through and visualizing the virtual machine is a pretty useful and fun experience that makes me appreciate more the language I use everyday.</p>

<p>Again, thanks to Philip Guo for the videos and Michael Kennedy for the podcast. Also, checkout Professor Guo&rsquo;s <a href="http://www.pythontutor.com/">python tutor</a> for visualizing how code is run.</p>
</div>


</article>


        <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://kevinjqiu.github.io/2015/09/03/use-python-bytecode-to-solve-puzzler/" data-via="kevinjqiu" data-counturl="http://kevinjqiu.github.io/2015/09/03/use-python-bytecode-to-solve-puzzler/" >Tweet</a>
  
  
  <div class="g-plusone" data-size="medium"></div>
  
  
    <div class="fb-like" data-send="true" data-width="450" data-show-faces="false"></div>
  
</div>




<section id="comments">
    <div id="disqus_thread"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
</section>


    			</div>
    			<footer id="footer">
    				<p class="credit">
  Copyright &copy; 2015 - Kevin Jing Qiu. Powered by <a href="http://octopress.org">Octopress</a>
</p>


    			</footer>
    			

<script type="text/javascript">
      var disqus_shortname = 'reminiscential';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://kevinjqiu.github.io/2015/09/03/use-python-bytecode-to-solve-puzzler/';
        var disqus_url = 'http://kevinjqiu.github.io/2015/09/03/use-python-bytecode-to-solve-puzzler/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id; js.async = true;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>




<link href='http://fonts.googleapis.com/css?family=Quattrocento+Sans|Roboto:400,300' rel='stylesheet' type='text/css'>


  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-32737230-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>




    		</div>
    	</section>
  	</div>
</body>
</html>
