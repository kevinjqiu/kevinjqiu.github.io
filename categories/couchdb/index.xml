<?xml version="1.0" encoding="utf-8" standalone="yes" ?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>Qiu&#39;s Quibble</title>
    <link>http://blog.idempotent.ca/categories/couchdb/index.xml</link>
    <description>Recent content on Qiu&#39;s Quibble</description>
    <generator>Hugo -- gohugo.io</generator>
    <language>en-us</language>
    <atom:link href="http://blog.idempotent.ca/categories/couchdb/index.xml" rel="self" type="application/rss+xml" />
    
    <item>
      <title>CouchDB Indexing Benchmark</title>
      <link>http://blog.idempotent.ca/2016/12/19/couchdb-indexing-benchmark/</link>
      <pubDate>Mon, 19 Dec 2016 23:34:56 -0500</pubDate>
      
      <guid>http://blog.idempotent.ca/2016/12/19/couchdb-indexing-benchmark/</guid>
      <description>

&lt;p&gt;In the &lt;a href=&#34;2016-11-16-couchdb-index-view-benchmark&#34;&gt;last post&lt;/a&gt;, we discussed how CouchDB&amp;rsquo;s external query server works by examining the raw protocol. In this post, we&amp;rsquo;re going to take a look at the performance of different query servers.&lt;/p&gt;

&lt;p&gt;The code used in this benchmarking is &lt;a href=&#34;https://gist.github.com/kevinjqiu/dd461b36a6f1d6d755d7a317d8f98b75&#34;&gt;here&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;I listed below the method of the benchmark in detail. If you want you can &lt;a href=&#34;#result-comparison&#34;&gt;jump to conclusion&lt;/a&gt;.&lt;/p&gt;

&lt;h1 id=&#34;the-setup&#34;&gt;The Setup&lt;/h1&gt;

&lt;p&gt;The benchmarks are done on my laptop (Intel 6th-gen i7 processor, 8G RAM, SSD) with CouchDB 1.6 in a docker container. Since we&amp;rsquo;re benchmarking python views as well, we&amp;rsquo;re going to customize the docker image add python query server to it. Here&amp;rsquo;s the dockerfile:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;FROM couchdb
RUN apt-get update -yqq &amp;amp;&amp;amp; apt-get install -y python python-pip
RUN pip install couchdb
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Build a new image with that dockerfile, and start a couchdb instance with (assuming you named your image &lt;code&gt;couchdb-python&lt;/code&gt; from the last step):&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;docker run -p 9999:5984 -d -v $(pwd)/data:/usr/local/var/lib/couchdb couchdb-python 
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Your couchdb instance will be accessible via &lt;code&gt;localhost:9999&lt;/code&gt;. By default, the container is started in the admin party mode (everybody is an admin) but since we use it only for the purpose of testing, we won&amp;rsquo;t bother with setting up username/password.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$ curl http://localhost:9999/
{&amp;quot;couchdb&amp;quot;:&amp;quot;Welcome&amp;quot;,&amp;quot;uuid&amp;quot;:&amp;quot;47a7b22e608a73fc2214ed13063923b8&amp;quot;,&amp;quot;version&amp;quot;:&amp;quot;1.6.1&amp;quot;,&amp;quot;vendor&amp;quot;:{&amp;quot;version&amp;quot;:&amp;quot;1.6.1&amp;quot;,&amp;quot;name&amp;quot;:&amp;quot;The Apache Software Foundation&amp;quot;}}
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;preparing-the-data&#34;&gt;Preparing the data&lt;/h2&gt;

&lt;p&gt;The data we&amp;rsquo;re working have simple structures. We&amp;rsquo;ll be generating data of the following form:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-json&#34;&gt;{
    &amp;quot;metadata&amp;quot;: {
        &amp;quot;docType&amp;quot;: &amp;quot;userscore&amp;quot;,
        &amp;quot;createdAt&amp;quot;: &amp;quot;2016-12-19T19:28:14.000&amp;quot;
    },
    &amp;quot;username&amp;quot;: &amp;quot;barry&amp;quot;,
    &amp;quot;score&amp;quot;: 912
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;We are storing the name of the user along with their score in the document, whatever that is. It&amp;rsquo;s a contrived example so bear with me :)&lt;/p&gt;

&lt;p&gt;To populate a dataset for our benchmarking, let&amp;rsquo;s use a script:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-python&#34;&gt;import string
import sys
import requests
import random
import datetime
from multiprocessing import Pool


DB_URL = &#39;http://localhost:9999/test&#39;


def random_name():
    generate_character = lambda _: random.choice(string.ascii_letters)
    return &#39;&#39;.join(map(generate_character, range(6)))


def random_date():
    # get a random date from within last year
    today = datetime.date.today()
    that_day = today - datetime.timedelta(days=random.randint(0, 366))
    return datetime.datetime.strftime(that_day, &#39;%Y-%m-%d&#39;)


def generate_doc(_):
    doc = {
        &#39;metadata&#39;: {
            &#39;docType&#39;: &#39;score&#39;,
            &#39;createdAt&#39;: random_date()
        },
        &#39;username&#39;: random_name(),
        &#39;score&#39;: random.randint(0, 5000)
    }
    response = requests.post(DB_URL, json=doc)
    response.raise_for_status()


if __name__ == &#39;__main__&#39;:
    num_of_docs = int(sys.argv[1])
    requests.delete(DB_URL)  # delete the database if it exists already
    response = requests.put(DB_URL)     # create the test database
    print(&#39;Generating {} docs&#39;.format(num_of_docs))
    pool = Pool(50)
    pool.map(generate_doc, range(num_of_docs))
    stats = requests.get(&#39;{}/&#39;.format(DB_URL)).json()
    print(&#39;doc_count: {}&#39;.format(stats[&#39;doc_count&#39;]))
    print(&#39;disk_size: {}&#39;.format(stats[&#39;disk_size&#39;]))
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;You can seed the database by using: &lt;code&gt;python /path/to/script.py 100000&lt;/code&gt; to create 100k documents. This is likely to take a while:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;python generate_data.py 100000
doc_count: 100000
disk_size: 111153301
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;As you can see, now we have a test database with 100000 documents.&lt;/p&gt;

&lt;h2 id=&#34;setup-python-query-server&#34;&gt;Setup Python Query Server&lt;/h2&gt;

&lt;p&gt;Python query server needs to be activated. You can either change it in the config file on the container and restart it or change it on the fly with the &lt;code&gt;_config&lt;/code&gt; endpoint.&lt;/p&gt;

&lt;p&gt;We can take a look at what&amp;rsquo;s currently configured:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$ curl http://localhost:9999/_config/query_servers
{&amp;quot;javascript&amp;quot;:&amp;quot;/usr/local/bin/couchjs /usr/local/share/couchdb/server/main.js&amp;quot;,&amp;quot;coffeescript&amp;quot;:&amp;quot;/usr/local/bin/couchjs /usr/local/share/couchdb/server/main-coffee.js&amp;quot;}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Let&amp;rsquo;s add python query server there:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;curl -XPUT -H&amp;quot;Content-Type: application/json&amp;quot; http://localhost:9999/_config/query_servers/python -d&#39;&amp;quot;/usr/bin/python /usr/local/bin/couchpy&amp;quot;&#39;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;and verify that it&amp;rsquo;s saved:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$ curl http://localhost:9999/_config/query_servers
{&amp;quot;javascript&amp;quot;:&amp;quot;/usr/local/bin/couchjs /usr/local/share/couchdb/server/main.js&amp;quot;,&amp;quot;coffeescript&amp;quot;:&amp;quot;/usr/local/bin/couchjs /usr/local/share/couchdb/server/main-coffee.js&amp;quot;,&amp;quot;python&amp;quot;:&amp;quot;/usr/bin/python /usr/local/bin/couchpy&amp;quot;}
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;benchmark-javascript-views&#34;&gt;Benchmark Javascript views&lt;/h2&gt;

&lt;p&gt;The view we are going to write is to calculate the total score of all users for a given month. We will have a map function to map each document to &lt;code&gt;([Year, Month], Score)&lt;/code&gt; and a reduce function to sum up all the scores.&lt;/p&gt;

&lt;h3 id=&#34;map-reduce-function&#34;&gt;Map/Reduce function&lt;/h3&gt;

&lt;p&gt;The map function written in Javascript:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-javascript&#34;&gt;function(doc) {
    if (doc.metadata &amp;amp;&amp;amp; doc.metadata.createdAt) {
        var parts = doc.metadata.createdAt.split(&amp;quot;-&amp;quot;),
            year = parts[0],
            month = parts[1];
        emit([year, month], doc.score);
    }
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;and the reduce function:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-javascript&#34;&gt;function(keys, values, rereduce) {
    return sum(values);
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Let&amp;rsquo;s save it as a design doc &lt;code&gt;_design/scoresByMonthJS:scoresByMonth&lt;/code&gt;. You can use either Futon or curl or &lt;a href=&#34;https://github.com/kevinjqiu/cdbcli&#34;&gt;cdbcli&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;To invoke the view, we can send a curl request to &lt;code&gt;http://localhost:9999/test/_design/scoresByMonthJS/_view/scoresByMonth?limit=11&amp;amp;group=true&lt;/code&gt;. However, keep in mind that whenever a view is invoked, the indexer will kick in and index any new changes since the last index. Because this is our first invocation of the view, it will index all changes (100K) so it&amp;rsquo;s going to take some time. This will be the opportunity for us to observe the speed of indexing, so before we invoke that, let&amp;rsquo;s get our script ready to monitor the speed of the indexing.&lt;/p&gt;

&lt;h3 id=&#34;monitor-changes-per-second-metric&#34;&gt;Monitor changes-per-second metric&lt;/h3&gt;

&lt;p&gt;CouchDB exposes its indexing status through the &lt;code&gt;/_active_tasks&lt;/code&gt; endpoint. It contains the number of changes to be indexed in total and the number of changes already indexed. From that, we can calculate the changes per second as our benchmark. As stated before, you can find the code &lt;a href=&#34;https://gist.github.com/kevinjqiu/dd461b36a6f1d6d755d7a317d8f98b75&#34;&gt;here&lt;/a&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;python cps.py _design/scoresByMonthJS
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;This starts a monitoring script on the specified design doc, and prints out changes per second number every 1 second.&lt;/p&gt;

&lt;p&gt;With this script running, in another terminal, let&amp;rsquo;s trigger the view:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;curl &amp;quot;http://localhost:9999/test/_design/scoresByMonthJS/_view/scoresByMonth?limit=11&amp;amp;group=true&amp;quot;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Go back to the terminal where the monitoring script is run. We will see that it started to print out cps values:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$ python cps.py _design/scoresByMonthJS
design doc: _design/scoresByMonthJS
Press Ctrl+C to exit
c/s = 4141.00
c/s = 7373.00
c/s = 7120.50
c/s = 5378.25
c/s = 5534.80
c/s = 5605.50
c/s = 5670.43
c/s = 5719.12
c/s = 5757.00
c/s = 6060.00
c/s = 6110.50
c/s = 6041.64
c/s = 5570.54
c/s = 5605.50
c/s = 5629.07
c/s = 5649.69
c/s = 5632.24
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;And when the indexing is complete, press Ctrl+C and the average will be printed out:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;^Caverage = 5799.93
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;and in the other terminal, we will see the result:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$ curl &amp;quot;http://localhost:9999/test/_design/scoresByMonthJS/_view/scoresByMonth?limit=11&amp;amp;group=true&amp;quot;

{&amp;quot;rows&amp;quot;:[
{&amp;quot;key&amp;quot;:[&amp;quot;2015&amp;quot;,&amp;quot;12&amp;quot;],&amp;quot;value&amp;quot;:8241946},
{&amp;quot;key&amp;quot;:[&amp;quot;2016&amp;quot;,&amp;quot;01&amp;quot;],&amp;quot;value&amp;quot;:20924965},
{&amp;quot;key&amp;quot;:[&amp;quot;2016&amp;quot;,&amp;quot;02&amp;quot;],&amp;quot;value&amp;quot;:19422002},
{&amp;quot;key&amp;quot;:[&amp;quot;2016&amp;quot;,&amp;quot;03&amp;quot;],&amp;quot;value&amp;quot;:21217217},
{&amp;quot;key&amp;quot;:[&amp;quot;2016&amp;quot;,&amp;quot;04&amp;quot;],&amp;quot;value&amp;quot;:20588868},
{&amp;quot;key&amp;quot;:[&amp;quot;2016&amp;quot;,&amp;quot;05&amp;quot;],&amp;quot;value&amp;quot;:21011332},
{&amp;quot;key&amp;quot;:[&amp;quot;2016&amp;quot;,&amp;quot;06&amp;quot;],&amp;quot;value&amp;quot;:20404601},
{&amp;quot;key&amp;quot;:[&amp;quot;2016&amp;quot;,&amp;quot;07&amp;quot;],&amp;quot;value&amp;quot;:20831013},
{&amp;quot;key&amp;quot;:[&amp;quot;2016&amp;quot;,&amp;quot;08&amp;quot;],&amp;quot;value&amp;quot;:21446896},
{&amp;quot;key&amp;quot;:[&amp;quot;2016&amp;quot;,&amp;quot;09&amp;quot;],&amp;quot;value&amp;quot;:20340594},
{&amp;quot;key&amp;quot;:[&amp;quot;2016&amp;quot;,&amp;quot;10&amp;quot;],&amp;quot;value&amp;quot;:20993863}
]}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;So the average for a Javascript view is around 5.8k changes per second.&lt;/p&gt;

&lt;h3 id=&#34;builtin-reducer&#34;&gt;Builtin Reducer&lt;/h3&gt;

&lt;p&gt;Many of you with CouchDB knowledge will quick to point out that I used a Javascript function as reducer to calculate the sum of the values. This is not very efficient, since (1) data will have to be serialized and sent to the external query server to calculate the result and (2) Javascript isn&amp;rsquo;t the fastest at mathematics (the default couchjs is using the Spider Monkey engine). We can cut short this loop by using the builtin &lt;code&gt;_sum&lt;/code&gt; reducer, which is written in Erlang and run on the same runtime as CouchDB itself, therefore, cut the roundtrip to the query server plus the serialization/deserialization cost.&lt;/p&gt;

&lt;p&gt;To use it, simply change the reducer function to &lt;code&gt;_sum&lt;/code&gt;. Start the monitoring and trigger indexing.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;design doc: _design/scoresByMonthJS
Press Ctrl+C to exit
c/s = 3333.00
c/s = 9696.00
c/s = 11312.00
c/s = 11850.67
c/s = 12069.50
c/s = 12221.00
c/s = 12338.83
c/s = 12365.29
c/s = 11741.25
^Caverage = 10769.73
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;So, by simply changing the reducer from external to builtin, the indexing speed improved &lt;code&gt;185.5%&lt;/code&gt;!&lt;/p&gt;

&lt;h2 id=&#34;benchmark-python-views&#34;&gt;Benchmark Python views&lt;/h2&gt;

&lt;h3 id=&#34;map-reduce&#34;&gt;Map/reduce&lt;/h3&gt;

&lt;p&gt;We save the following map/reduce function as &lt;code&gt;_design/scoresByMonthPY&lt;/code&gt;:&lt;/p&gt;

&lt;p&gt;Map:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;def map(doc):
    if &#39;metadata&#39; in doc and &#39;createdAt&#39; in doc[&#39;metadata&#39;]:
        created_at = doc[&#39;metadata&#39;][&#39;createdAt&#39;]
        year, month, _ = created_at.split(&#39;-&#39;)
        yield [year, month], doc[&#39;score&#39;]
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Reduce:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;def reduce(keys, values, rereduce):
    return sum(values)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;We use a sub-optimal reducer to draw comparison with the first Javascript benchmark we did before. And it turned out that Python views are slightly more performant:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$ python cps.py _design/scoresByMonthPY
design doc: _design/scoresByMonthPY
Press Ctrl+C to exit
c/s = 2323.00
c/s = 6969.00
c/s = 8433.50
c/s = 8719.67
c/s = 8913.25
c/s = 8948.60
c/s = 8972.17
c/s = 9003.43
c/s = 9014.25
c/s = 9011.44
c/s = 9019.30
^Caverage = 8120.69
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Let&amp;rsquo;s switch the reducer to CouchDB&amp;rsquo;s builtin &lt;code&gt;_sum&lt;/code&gt; function.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;design doc: _design/scoresByMonthPY
Press Ctrl+C to exit
c/s = 5959.00
c/s = 8938.50
c/s = 9864.33
c/s = 10403.00
c/s = 11842.25
c/s = 11837.20
c/s = 11833.83
c/s = 11802.57
c/s = 11753.88
^Caverage = 10470.51
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;The result isn&amp;rsquo;t that different from Javascript map function with builtin reducer.&lt;/p&gt;

&lt;h3 id=&#34;improving-couchpy&#34;&gt;Improving couchpy&lt;/h3&gt;

&lt;h4 id=&#34;simplejson&#34;&gt;simplejson&lt;/h4&gt;

&lt;p&gt;Since an external query server need to deserialize JSON input from CouchDB and serialize the result back into JSON form to be consumed by CouchDB, the implementation of the JSON module could potentially make a difference in performance. As &lt;code&gt;couchpy&lt;/code&gt; defaults to use the system &lt;code&gt;json&lt;/code&gt; module provided by the Python distribution, it&amp;rsquo;s not the most performant implementation. &lt;code&gt;simplejson&lt;/code&gt; is a drop-in replacement for the Python&amp;rsquo;s &lt;code&gt;json&lt;/code&gt; module which uses a C implementation for json encoding/decoding. Let&amp;rsquo;s try that.&lt;/p&gt;

&lt;p&gt;First, we need to install simplejson (which requires Python C headers to be installed. On Debian, install &lt;code&gt;python-dev&lt;/code&gt; package) on the container and then modify the config to use &lt;code&gt;couchpy --json-module=simplejson&lt;/code&gt; as the Python query server command.&lt;/p&gt;

&lt;p&gt;Let&amp;rsquo;s see the result:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$ python cps.py _design/scoresByMonthPY
design doc: _design/scoresByMonthPY
Press Ctrl+C to exit
c/s = 5454.00
c/s = 11514.00
c/s = 12019.00
c/s = 12120.00
c/s = 9675.80
c/s = 9999.00
c/s = 10316.43
c/s = 10516.62
^Caverage = 10201.86
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Interesting&amp;hellip; &lt;code&gt;simplejson&lt;/code&gt; performance is only on-par with dthe stock &lt;code&gt;json&lt;/code&gt; module. That&amp;rsquo;s a little unexpected. However, if you look at &lt;code&gt;top&lt;/code&gt; while the indexer is running, the Python process never consumes more than 60% of CPU time.&lt;/p&gt;

&lt;h4 id=&#34;pypy&#34;&gt;PyPy&lt;/h4&gt;

&lt;p&gt;We can also try to use pypy as our interpreter. PyPy is an alternative implementation of Python that adds a Just-In-Time compiler. The benchmark showed a marginal improvement over CPython.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$ python cps.py _design/scoresByMonthPY
design doc: _design/scoresByMonthPY
Press Ctrl+C to exit
c/s = 6767.00
c/s = 10453.50
c/s = 11648.67
c/s = 12195.75
c/s = 12524.00
c/s = 13816.80
c/s = 12841.43
^Caverage = 11463.88
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;The performance for PyPy isn&amp;rsquo;t much greater is probably due to the fact how the CouchDB query protocol works: it sends the query server one document at a time to run the map function over. JIT excels at loops but at each request/response cycle, the query server only operates one document at a time. The JIT wasn&amp;rsquo;t given a chance to warmup. That was my conjecture anyway, as I&amp;rsquo;m not an expert on PyPy&amp;rsquo;s JIT internals.&lt;/p&gt;

&lt;h2 id=&#34;native-views&#34;&gt;Native Views&lt;/h2&gt;

&lt;p&gt;As we can see, the performance of external query servers don&amp;rsquo;t vary by a lot. Another interesting observation is that the query server process was not fully saturated, doesn&amp;rsquo;t matter when it&amp;rsquo;s Javascript, Python, or PyPy.&lt;/p&gt;

&lt;p&gt;Looking at the &lt;a href=&#34;2016-11-16-couchdb-index-view-benchmark&#34;&gt;CouchDB query protocol&lt;/a&gt;, it seemed that the process of feeding data to the external query server is the bottleneck: The CouchDB erlang process serializes the document from Erlang to JSON, send JSON to the query server&amp;rsquo;s process. The query server deserializes JSON, run the map/reduce function and serializes that into JSON to be fed back to the CouchDB process, and the CouchDB process deserializes that back into Erlang&amp;rsquo;s data structure. Wouldn&amp;rsquo;t it be great if all of that can happen within the same runtime as the CouchDB process? That brought me to research writing CouchDB views in Erlang, and indeed, there is &lt;a href=&#34;https://wiki.apache.org/couchdb/EnableErlangViews&#34;&gt;such a thing&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Having dabbled with Erlang at the beginning of my career, I&amp;rsquo;m not put off by the idea. However, Erlang is not a beginner-friendly language if you&amp;rsquo;re coming from the C/C++/Java line.&lt;/p&gt;

&lt;p&gt;First we need to enable Erlang native query server in the configs.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;curl -XPUT -H &amp;quot;Content-Type:application/json&amp;quot; http://localhost:9999/_config/native_query_servers/erlang -d&#39;&amp;quot;{couch_native_process, start_link, []}&amp;quot;&#39;
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;map&#34;&gt;Map&lt;/h3&gt;

&lt;p&gt;It takes some trial-and-error but there it is, the Erlang version of the map function:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;fun({Doc})-&amp;gt;
    case proplists:get_value(&amp;lt;&amp;lt;&amp;quot;metadata&amp;quot;&amp;gt;&amp;gt;, Doc) of
        {Metadata} -&amp;gt;
            CreatedAt = proplists:get_value(&amp;lt;&amp;lt;&amp;quot;createdAt&amp;quot;&amp;gt;&amp;gt;, Metadata),
            case string:tokens(binary_to_list(CreatedAt), &amp;quot;-&amp;quot;) of
                [Year, Month|_] -&amp;gt; Emit([list_to_binary(Year), list_to_binary(Month)], proplists:get_value(&amp;lt;&amp;lt;&amp;quot;score&amp;quot;&amp;gt;&amp;gt;, Doc))
        end
    end
end.
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;CouchDB documents are represented in Erlang as a tuple of lists (proplists), and hence we use &lt;a href=&#34;http://erlang.org/doc/man/proplists.html&#34;&gt;&lt;code&gt;proplists:get_value&lt;/code&gt;&lt;/a&gt; to extract values given certain &amp;ldquo;keys&amp;rdquo;. Erlang has great pattern-matching feature so we use it to further extract &lt;code&gt;Year&lt;/code&gt; and &lt;code&gt;Month&lt;/code&gt; from the split string. Strings in Erlang are represented as a list of binary numbers (referring to their codepoint). &lt;code&gt;&amp;lt;&amp;lt;&amp;quot;createdAt&amp;quot;&amp;gt;&amp;gt;&lt;/code&gt; is the literal to convert the string &lt;code&gt;createdAt&lt;/code&gt; to its binary list equivalent to match the type of the document object. Again, I&amp;rsquo;m not an Erlang expert, so please point out my inaccuracies with regard to the language.&lt;/p&gt;

&lt;h3 id=&#34;reduce&#34;&gt;Reduce&lt;/h3&gt;

&lt;p&gt;We will use the same reducer &lt;code&gt;_sum&lt;/code&gt; as it has served us well.&lt;/p&gt;

&lt;h3 id=&#34;benchmark&#34;&gt;Benchmark&lt;/h3&gt;

&lt;pre&gt;&lt;code&gt;$ python cps.py _design/scoresByMonthERL
design doc: _design/scoresByMonthERL
Press Ctrl+C to exit
c/s = 19821.25
^Caverage = 19821.25
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;There you have it! The Erlang view is about 173% as fast as the previous fastest (PyPy) option.&lt;/p&gt;

&lt;p&gt;One &lt;strong&gt;caveat&lt;/strong&gt; about using Erlang native views: since it&amp;rsquo;s running on the same runtime as CouchDB and is not sandboxed, it&amp;rsquo;s able to access CouchDB&amp;rsquo;s internal API and call Erlang functions that maybe destructive. Do not run untrusted view functions directly.&lt;/p&gt;

&lt;p&gt;Let&amp;rsquo;s look at where we stand in terms of indexer option and performance:&lt;/p&gt;

&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;Option&lt;/th&gt;
&lt;th&gt;Average c/s&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;

&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;couchjs/external reducer&lt;/td&gt;
&lt;td&gt;5799.93&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;couchjs/builtin reducer&lt;/td&gt;
&lt;td&gt;10769.73&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;couchpy/external reducer&lt;/td&gt;
&lt;td&gt;8120.69&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;couchpy/builtin reducer&lt;/td&gt;
&lt;td&gt;10470.51&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;couchpy/simplejson/builtin reducer&lt;/td&gt;
&lt;td&gt;10201.86&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;couchpy/pypy/builtin reducer&lt;/td&gt;
&lt;td&gt;11463.88&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;erlang native view&lt;/td&gt;
&lt;td&gt;19821.25&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;


&lt;figure &gt;
    
        &lt;img src=&#34;http://blog.idempotent.ca/images/couchdb-indexing-benchmark.png&#34; /&gt;
    
    
    &lt;figcaption&gt;
        &lt;h4&gt;Benchmark&lt;/h4&gt;
        
    &lt;/figcaption&gt;
    
&lt;/figure&gt;


&lt;h2 id=&#34;benchmark-with-bigger-documents&#34;&gt;Benchmark with bigger documents&lt;/h2&gt;

&lt;p&gt;The above set of tests are done on documents with smallish size. Let&amp;rsquo;s add some junk data to the documents. I modified the document generation procedure to add in some arbitrary string properties so now the average document size is about 300k.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-python&#34;&gt;def generate_doc(i):
    doc = {
        &#39;metadata&#39;: {
            &#39;docType&#39;: &#39;score&#39;,
            &#39;createdAt&#39;: random_date()
        },
        &#39;username&#39;: random_str(),
        &#39;score&#39;: random.randint(0, 5000),
        &#39;custom_data&#39;: {
        }
    }

    for _ in range(random.randint(0, 100)):
        doc[&#39;custom_data&#39;][random_str()] = \
            base64.b64encode((random_str() * 100).encode(&#39;ascii&#39;)).decode(&#39;ascii&#39;)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;with this new database, rerun the above benchmark. We have:&lt;/p&gt;

&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;Option&lt;/th&gt;
&lt;th&gt;Average c/s&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;

&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;couchjs/external reducer&lt;/td&gt;
&lt;td&gt;648.50&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;couchjs/builtin reducer&lt;/td&gt;
&lt;td&gt;727.18&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;couchpy/external reducer&lt;/td&gt;
&lt;td&gt;1564.38&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;couchpy/builtin reducer&lt;/td&gt;
&lt;td&gt;1590.20&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;couchpy/simplejson/builtin reducer&lt;/td&gt;
&lt;td&gt;2352.69&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;couchpy/pypy/builtin reducer&lt;/td&gt;
&lt;td&gt;1265.20&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;erlang native view&lt;/td&gt;
&lt;td&gt;9363.44&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;


&lt;figure &gt;
    
        &lt;img src=&#34;http://blog.idempotent.ca/images/couchdb-indexing-benchmark-300k.png&#34; /&gt;
    
    
    &lt;figcaption&gt;
        &lt;h4&gt;Benchmark @ 300k&lt;/h4&gt;
        
    &lt;/figcaption&gt;
    
&lt;/figure&gt;


&lt;h2 id=&#34;result-comparison&#34;&gt;Result Comparison&lt;/h2&gt;

&lt;p&gt;Let&amp;rsquo;s combine the two tables together:&lt;/p&gt;

&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;Option&lt;/th&gt;
&lt;th&gt;cps@1k&lt;/th&gt;
&lt;th&gt;cps@300k&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;

&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;couchjs/external reducer&lt;/td&gt;
&lt;td&gt;5799.93&lt;/td&gt;
&lt;td&gt;648.50&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;couchjs/builtin reducer&lt;/td&gt;
&lt;td&gt;10769.73&lt;/td&gt;
&lt;td&gt;727.18&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;couchpy/external reducer&lt;/td&gt;
&lt;td&gt;8120.69&lt;/td&gt;
&lt;td&gt;1564.38&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;couchpy/builtin reducer&lt;/td&gt;
&lt;td&gt;10470.51&lt;/td&gt;
&lt;td&gt;1590.20&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;couchpy/simplejson/builtin reducer&lt;/td&gt;
&lt;td&gt;10201.86&lt;/td&gt;
&lt;td&gt;2352.69&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;couchpy/pypy/builtin reducer&lt;/td&gt;
&lt;td&gt;11463.88&lt;/td&gt;
&lt;td&gt;1265.20&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;erlang native view&lt;/td&gt;
&lt;td&gt;19821.25&lt;/td&gt;
&lt;td&gt;9363.44&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;

&lt;p&gt;Here are some conclusion we can draw from this experiment:
- Native Erlang views are the fastest by a large margin.
- Native Erlang views&amp;rsquo; advantage is even more obvious when documents are larger
- Avoid external reducer as much as you can. (i.e., Use the builtin reducer whenever you can)
- PyPy does not offer performance improvements for Python views (in some cases, it&amp;rsquo;s worse) probably due to the way query protocol works
- The default Javascript view performance isn&amp;rsquo;t great
- Use simplejson for Python view when documents are larger&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>CouchDB Query Protocol</title>
      <link>http://blog.idempotent.ca/2016/11/16/couchdb-query-protocol/</link>
      <pubDate>Wed, 16 Nov 2016 00:05:38 -0500</pubDate>
      
      <guid>http://blog.idempotent.ca/2016/11/16/couchdb-query-protocol/</guid>
      <description>

&lt;p&gt;Recently at &lt;code&gt;$DAYJOB&lt;/code&gt; I had the opportunity to look deeper into how &lt;a href=&#34;https://couchdb.apache.org&#34;&gt;CouchDB&lt;/a&gt; indexing works and compared the performance of different indexers. Hopefully this series of articles will shed some light on how to get the most out of CouchDB&amp;rsquo;s view indexing.&lt;/p&gt;

&lt;p&gt;In this article we&amp;rsquo;ll be going over the concept of CouchDB views and find out just how CouchDB indexes documents with the help of external query servers.&lt;/p&gt;

&lt;p&gt;The version of CouchDB we will be using is 1.6.&lt;/p&gt;

&lt;h1 id=&#34;couchdb-views&#34;&gt;CouchDB views&lt;/h1&gt;

&lt;p&gt;CouchDB is a document-oriented database that&amp;rsquo;s super easy to get started. You serialize your data into JSON, and throw it on the wire to CouchDB via an HTTP interface. To get the data out (querying) though, you will need to write &amp;ldquo;design docs&amp;rdquo; that contain map/reduce functions. Internally, CouchDB uses the map/reduce functions to build up a B+Tree index, so querying against that view is a simple tree lookup.&lt;/p&gt;

&lt;p&gt;Out-of-the-box, CouchDB supports views written in JavaScript, however, support for other languages are available thanks to the CouchDB &lt;a href=&#34;http://docs.couchdb.org/en/1.6.1/query-server/protocol.html&#34;&gt;query server protocol&lt;/a&gt;. CouchDB process itself does not do any querying. It simply loops through all the changes that have not been indexed since the last time, and send the changes to the external query server.&lt;/p&gt;

&lt;h2 id=&#34;mapreduce-view-updater&#34;&gt;MapReduce view updater&lt;/h2&gt;

&lt;p&gt;View indexing is triggered by the map-reduce view updater.&lt;/p&gt;

&lt;p&gt;The following snippet is where it happens (&lt;code&gt;couch_mrview/src/couch_mrview_updater.erl&lt;/code&gt;):&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;map_docs(Parent, State0) -&amp;gt;                                                                                                                                                                   
    case couch_work_queue:dequeue(State0#mrst.doc_queue) of
        ...
        {ok, Dequeued} -&amp;gt;
            ...
            QServer = State1#mrst.qserver,
            DocFun = fun
                ...
                ({Id, Seq, Doc}, {SeqAcc, Results}) -&amp;gt;
                    {ok, Res} = couch_query_servers:map_doc_raw(QServer, Doc),
                    {erlang:max(Seq, SeqAcc), [{Id, Res} | Results]}
            end,
            ...
            couch_work_queue:queue(State1#mrst.write_queue, Results),
            map_docs(Parent, State1)
    end.
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;and &lt;code&gt;couch_query_servers:map_doc_raw&lt;/code&gt; is encodes the document into JSON and sends it over to the external query server process:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;map_doc_raw(Proc, Doc) -&amp;gt;                                                                                                                                                                     
    Json = couch_doc:to_json_obj(Doc, []),
    {ok, proc_prompt_raw(Proc, [&amp;lt;&amp;lt;&amp;quot;map_doc&amp;quot;&amp;gt;&amp;gt;, Json])}.

...
proc_prompt_raw(#proc{prompt_fun = {Mod, Func}} = Proc, Args) -&amp;gt;                                                                                                                              
    apply(Mod, Func, [Proc#proc.pid, Args]).
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;external-query-server&#34;&gt;External Query Server&lt;/h2&gt;

&lt;p&gt;The document is sent along with the action to be performed (&lt;a href=&#34;http://docs.couchdb.org/en/1.6.1/query-server/protocol.html#map-doc&#34;&gt;map_doc&lt;/a&gt;) to beh external query server process&amp;rsquo; stdin. Let&amp;rsquo;s have a look at how an external query server is implemented. We&amp;rsquo;ll take &lt;a href=&#34;https://github.com/djc/couchdb-python/blob/master/couchdb/view.py#L182&#34;&gt;couchpy&lt;/a&gt; as an example but it applies to any external query servers.&lt;/p&gt;

&lt;p&gt;When a &lt;code&gt;map_docs&lt;/code&gt; command is received via stdin of the couchpy process, the &lt;a href=&#34;https://github.com/djc/couchdb-python/blob/master/couchdb/view.py#L75-L85&#34;&gt;following code&lt;/a&gt; is being executed:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-python&#34;&gt;def map_doc(doc):
    results = []
    for function in functions:
        try:
            results.append([[key, value] for key, value in function(doc)])
        except Exception as e:
            log.error(&#39;runtime error in map function: %s&#39;, e,
                      exc_info=True)
            results.append([])
            _log(traceback.format_exc())
    return results
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Nothing too special here. The doc is passed to all &lt;code&gt;functions&lt;/code&gt; inside the closure and the output of the function is gathered into a list to be returned. &lt;code&gt;functions&lt;/code&gt; here is a variable available to the &lt;code&gt;map_doc&lt;/code&gt; closure and is initialized by the &lt;a href=&#34;http://docs.couchdb.org/en/1.6.1/query-server/protocol.html#add-fun&#34;&gt;&lt;code&gt;add_lib&lt;/code&gt;&lt;/a&gt; call, which is triggered when a view is being indexed.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-python&#34;&gt;def add_fun(string):
    string = BOM_UTF8 + string.encode(&#39;utf-8&#39;)
    globals_ = {}
    try:
        util.pyexec(string, {&#39;log&#39;: _log}, globals_)
    except Exception as e:
        return {&#39;error&#39;: {
            &#39;id&#39;: &#39;map_compilation_error&#39;,
            &#39;reason&#39;: e.args[0]
        }}
    err = {&#39;error&#39;: {
        &#39;id&#39;: &#39;map_compilation_error&#39;,
        &#39;reason&#39;: &#39;string must eval to a function &#39;
                  &#39;(ex: &amp;quot;def(doc): return 1&amp;quot;)&#39;
    }}
    if len(globals_) != 1:
        return err
    function = list(globals_.values())[0]
    if type(function) is not FunctionType:
        return err
    functions.append(function)
    return True
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;code&gt;util.pyexec&lt;/code&gt; is a simple wrapper around the &lt;code&gt;exec&lt;/code&gt; keyword in Python that turns code string into a function object:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-python&#34;&gt;def pyexec(code, gns, lns):
    exec(code, gns, lns)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;What this tells us is that &lt;strong&gt;CouchDB&amp;rsquo;s view functions inside the same design document get indexed together&lt;/strong&gt;. If you have a design document that contains multiple view functions that operate on different types of documents, this could negatively impact your performance. It&amp;rsquo;s usually a good idea to have one view function per design document, unless the view functions have very strong cohesion.&lt;/p&gt;

&lt;h1 id=&#34;couchdb-query-protocol-in-practice&#34;&gt;CouchDB Query Protocol in Practice&lt;/h1&gt;

&lt;p&gt;Now that we looked at how CouchDB invokes external query servers and how an external query server respond to certain protocol commands, let&amp;rsquo;s put this into practice. We&amp;rsquo;d like to examine what&amp;rsquo;s going on when a view is being indexed. We&amp;rsquo;ll use couchpy again as an example.&lt;/p&gt;

&lt;p&gt;First, let&amp;rsquo;s create a couple of docs, each with a key &amp;ldquo;type&amp;rdquo; to indicate the type of documents:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ curl -XPOST -H&amp;quot;Content-Type:application/json&amp;quot; http://localhost:5984/test -d&#39;{&amp;quot;type&amp;quot;: &amp;quot;foo&amp;quot;}&#39;
{&amp;quot;ok&amp;quot;:true,&amp;quot;id&amp;quot;:&amp;quot;db13c4d7dbf11110f1eadce071001e87&amp;quot;,&amp;quot;rev&amp;quot;:&amp;quot;1-52308d7a89c9fb18c4c4e47d759834ed&amp;quot;}

$ curl -XPOST -H&amp;quot;Content-Type:application/json&amp;quot; http://localhost:5984/test -d&#39;{&amp;quot;type&amp;quot;: &amp;quot;foo&amp;quot;}&#39;
{&amp;quot;ok&amp;quot;:true,&amp;quot;id&amp;quot;:&amp;quot;db13c4d7dbf11110f1eadce071000f53&amp;quot;,&amp;quot;rev&amp;quot;:&amp;quot;1-52308d7a89c9fb18c4c4e47d759834ed&amp;quot;}

$ curl -XPOST -H&amp;quot;Content-Type:application/json&amp;quot; http://localhost:5984/test -d&#39;{&amp;quot;type&amp;quot;: &amp;quot;bar&amp;quot;}&#39;
{&amp;quot;ok&amp;quot;:true,&amp;quot;id&amp;quot;:&amp;quot;db13c4d7dbf11110f1eadce07100189b&amp;quot;,&amp;quot;rev&amp;quot;:&amp;quot;1-17ac4eb1776289a8d73ea6990401c56a&amp;quot;}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Then let&amp;rsquo;s create a design doc that has a view function to map docs according to their types:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-python&#34;&gt;def map(doc):
    yield doc.get(&#39;type&#39;, None), None
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Save it as &lt;code&gt;_design/byType&lt;/code&gt; and view name: &lt;code&gt;byType&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;To turn on couchpy logging, we can update CouchDB configuration via Futon. Go to &lt;a href=&#34;http://localhost:5984/_utils/config.html&#34;&gt;http://localhost:5984/_utils/config.html&lt;/a&gt; and find key &lt;code&gt;python&lt;/code&gt; the section &lt;code&gt;query_servers&lt;/code&gt;, change the command to &lt;code&gt;/usr/local/bin/couchpy --debug --log-file=/tmp/couchpy.log&lt;/code&gt;. Erlang config change does not require server reload, so this should take effect immediately.&lt;/p&gt;

&lt;p&gt;Next, let&amp;rsquo;s tail the log file:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;log -F /tmp/couchpy.log
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Now, trigger the view index by querying the view you have just created:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;curl http://localhost:5984/test/_design/byType/_view/byType
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;You should be seeing in &lt;code&gt;/tmp/couchpy.log&lt;/code&gt;:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;[2016-12-05 23:52:31,380] [DEBUG] Processing [u&#39;reset&#39;, {u&#39;timeout&#39;: 5000, u&#39;reduce_limit&#39;: True}]
[2016-12-05 23:52:31,381] [DEBUG] Returning  True
[2016-12-05 23:52:31,381] [DEBUG] Processing [u&#39;add_fun&#39;, u&amp;quot;def map(doc):\n  yield doc.get(&#39;type&#39;, None), None&amp;quot;]
[2016-12-05 23:52:31,381] [DEBUG] Returning  True
[2016-12-05 23:52:31,381] [DEBUG] Processing [u&#39;map_doc&#39;, {u&#39;_rev&#39;: u&#39;1-17ac4eb1776289a8d73ea6990401c56a&#39;, u&#39;_id&#39;: u&#39;db13c4d7dbf11110f1eadce071002ee1&#39;, u&#39;type&#39;: u&#39;bar&#39;}]
[2016-12-05 23:52:31,381] [DEBUG] Returning  [[[u&#39;bar&#39;, None]]]
[2016-12-05 23:52:31,382] [DEBUG] Processing [u&#39;map_doc&#39;, {u&#39;_rev&#39;: u&#39;1-52308d7a89c9fb18c4c4e47d759834ed&#39;, u&#39;_id&#39;: u&#39;db13c4d7dbf11110f1eadce071002546&#39;, u&#39;type&#39;: u&#39;foo&#39;}]
[2016-12-05 23:52:31,382] [DEBUG] Returning  [[[u&#39;foo&#39;, None]]]
[2016-12-05 23:52:31,382] [DEBUG] Processing [u&#39;map_doc&#39;, {u&#39;_rev&#39;: u&#39;1-52308d7a89c9fb18c4c4e47d759834ed&#39;, u&#39;_id&#39;: u&#39;db13c4d7dbf11110f1eadce071001e87&#39;, u&#39;type&#39;: u&#39;foo&#39;}]
[2016-12-05 23:52:31,382] [DEBUG] Returning  [[[u&#39;foo&#39;, None]]]
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;There we have it! CouchDB querying in action!&lt;/p&gt;

&lt;h2 id=&#34;reset&#34;&gt;reset&lt;/h2&gt;

&lt;pre&gt;&lt;code&gt;[u&#39;reset&#39;, {u&#39;timeout&#39;: 5000, u&#39;reduce_limit&#39;: True}]
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;The first step is a &lt;a href=&#34;http://docs.couchdb.org/en/1.6.1/query-server/protocol.html#reset&#34;&gt;&lt;code&gt;reset&lt;/code&gt; operation&lt;/a&gt; when the internal state of the query server is cleared. Couchpy simply clears the &lt;code&gt;functions&lt;/code&gt; list:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-python&#34;&gt; def reset(config=None):
      del functions[:]
      return True
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Couchpy seems to be ignoring the &lt;code&gt;timeout&lt;/code&gt; and &lt;code&gt;reduce_limit&lt;/code&gt; parameters passed in. Hrm&amp;hellip;&lt;/p&gt;

&lt;h2 id=&#34;add-fun&#34;&gt;add_fun&lt;/h2&gt;

&lt;pre&gt;&lt;code&gt;[u&#39;add_fun&#39;, u&amp;quot;def map(doc):\n  yield doc.get(&#39;type&#39;, None), None&amp;quot;]
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;This is the next stage of indexing. CouchDB server sends the functions in the design doc to the query server. As we have seen earlier, couchpy calls Python&amp;rsquo;s &lt;code&gt;exec&lt;/code&gt; on the code, and save it as function objects internally.&lt;/p&gt;

&lt;h2 id=&#34;map-doc&#34;&gt;map_doc&lt;/h2&gt;

&lt;pre&gt;&lt;code&gt;[u&#39;map_doc&#39;, {u&#39;_rev&#39;: u&#39;1-17ac4eb1776289a8d73ea6990401c56a&#39;, u&#39;_id&#39;: u&#39;db13c4d7dbf11110f1eadce071002ee1&#39;, u&#39;type&#39;: u&#39;bar&#39;}]
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;After the internal state of the query server is setup, CouchDB will pass all eligible documents to the query server along with the operation &lt;code&gt;map_doc&lt;/code&gt;. This will invoke all functions added via &lt;code&gt;add_fun&lt;/code&gt; call in the query server&amp;rsquo;s process on the document being passed.&lt;/p&gt;

&lt;p&gt;The result of the function is collected into a list and returned to CouchDB via the processes&amp;rsquo; stdout.&lt;/p&gt;

&lt;h1 id=&#34;index-new-changes&#34;&gt;Index New Changes&lt;/h1&gt;

&lt;h2 id=&#34;adding-a-new-document&#34;&gt;Adding a New Document&lt;/h2&gt;

&lt;p&gt;Now what happens if we add another document to the database?&lt;/p&gt;

&lt;p&gt;Let&amp;rsquo;s try it.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$ curl -XPOST -H&amp;quot;Content-Type:application/json&amp;quot; http://localhost:5984/test -d&#39;{&amp;quot;type&amp;quot;: &amp;quot;bar&amp;quot;}&#39;
{&amp;quot;ok&amp;quot;:true,&amp;quot;id&amp;quot;:&amp;quot;db13c4d7dbf11110f1eadce071003893&amp;quot;,&amp;quot;rev&amp;quot;:&amp;quot;1-17ac4eb1776289a8d73ea6990401c56a&amp;quot;}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;There we added a second &lt;code&gt;bar&lt;/code&gt; document. Observe &lt;code&gt;/tmp/couchpy.log&lt;/code&gt;. Nothing! That&amp;rsquo;s right. Views in CouchDB 1.x &lt;strong&gt;does not get indexed until the view is being queried&lt;/strong&gt;. If you&amp;rsquo;re using CouchDB 1.x, it pays to have a cron job that periodically query all your views just to keep the views &amp;ldquo;warm&amp;rdquo;, so your less-frequently used views are kept up to update and don&amp;rsquo;t get hit with long indexing time when they do get queried.&lt;/p&gt;

&lt;p&gt;Let&amp;rsquo;s trigger query the view:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$ curl http://localhost:5984/test/_design/byType/_view/byType
{&amp;quot;total_rows&amp;quot;:4,&amp;quot;offset&amp;quot;:0,&amp;quot;rows&amp;quot;:[
{&amp;quot;id&amp;quot;:&amp;quot;db13c4d7dbf11110f1eadce071002ee1&amp;quot;,&amp;quot;key&amp;quot;:&amp;quot;bar&amp;quot;,&amp;quot;value&amp;quot;:null},
{&amp;quot;id&amp;quot;:&amp;quot;db13c4d7dbf11110f1eadce071003893&amp;quot;,&amp;quot;key&amp;quot;:&amp;quot;bar&amp;quot;,&amp;quot;value&amp;quot;:null},
{&amp;quot;id&amp;quot;:&amp;quot;db13c4d7dbf11110f1eadce071001e87&amp;quot;,&amp;quot;key&amp;quot;:&amp;quot;foo&amp;quot;,&amp;quot;value&amp;quot;:null},
{&amp;quot;id&amp;quot;:&amp;quot;db13c4d7dbf11110f1eadce071002546&amp;quot;,&amp;quot;key&amp;quot;:&amp;quot;foo&amp;quot;,&amp;quot;value&amp;quot;:null}
]}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;and now we get something in &lt;code&gt;couchpy.log&lt;/code&gt; file:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;[2016-12-06 00:49:22,327] [DEBUG] Processing [u&#39;reset&#39;, {u&#39;timeout&#39;: 5000, u&#39;reduce_limit&#39;: True}]
[2016-12-06 00:49:22,327] [DEBUG] Returning  True
[2016-12-06 00:49:22,327] [DEBUG] Processing [u&#39;add_fun&#39;, u&amp;quot;def map(doc):\n  yield doc.get(&#39;type&#39;, None), None &amp;quot;]
[2016-12-06 00:49:22,328] [DEBUG] Returning  True
[2016-12-06 00:49:22,328] [DEBUG] Processing [u&#39;map_doc&#39;, {u&#39;_rev&#39;: u&#39;1-17ac4eb1776289a8d73ea6990401c56a&#39;, u&#39;_id&#39;: u&#39;db13c4d7dbf11110f1eadce071003893&#39;, u&#39;type&#39;: u&#39;bar&#39;}]
[2016-12-06 00:49:22,328] [DEBUG] Returning  [[[u&#39;bar&#39;, None]]]
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;As you can see, &lt;code&gt;reset&lt;/code&gt; and &lt;code&gt;add_fun&lt;/code&gt; are called again, because couchpy processes do not preserve their internal state once a view is finish indexing, and the &lt;code&gt;map_doc&lt;/code&gt; operation is only called on the new document.&lt;/p&gt;

&lt;h2 id=&#34;updating-a-document&#34;&gt;Updating a Document&lt;/h2&gt;

&lt;p&gt;Let&amp;rsquo;s now change one of the docs:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$ curl -XPOST -H&amp;quot;Content-Type:application/json&amp;quot; http://localhost:5984/test -d&#39;{&amp;quot;_id&amp;quot;: &amp;quot;db13c4d7dbf11110f1eadce071001e87&amp;quot;, &amp;quot;_rev&amp;quot;: &amp;quot;1-52308d7a89c9fb18c4c4e47d759834ed&amp;quot;, &amp;quot;type&amp;quot;: &amp;quot;quux&amp;quot;}&#39;
{&amp;quot;ok&amp;quot;:true,&amp;quot;id&amp;quot;:&amp;quot;db13c4d7dbf11110f1eadce071001e87&amp;quot;,&amp;quot;rev&amp;quot;:&amp;quot;2-2f95b6ed98722bf4a7d8750faa316313&amp;quot;}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;and trigger view indexing. See what we&amp;rsquo;ve got in couchpy logs:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;[2016-12-06 00:55:33,411] [DEBUG] Processing [u&#39;reset&#39;, {u&#39;timeout&#39;: 5000, u&#39;reduce_limit&#39;: True}]
[2016-12-06 00:55:33,412] [DEBUG] Returning  True
[2016-12-06 00:55:33,412] [DEBUG] Processing [u&#39;add_fun&#39;, u&amp;quot;def map(doc):\n  yield doc.get(&#39;type&#39;, None), None &amp;quot;]
[2016-12-06 00:55:33,412] [DEBUG] Returning  True
[2016-12-06 00:55:33,412] [DEBUG] Processing [u&#39;map_doc&#39;, {u&#39;_rev&#39;: u&#39;2-2f95b6ed98722bf4a7d8750faa316313&#39;, u&#39;_id&#39;: u&#39;db13c4d7dbf11110f1eadce071001e87&#39;, u&#39;type&#39;: u&#39;quux&#39;}]
[2016-12-06 00:55:33,412] [DEBUG] Returning  [[[u&#39;quux&#39;, None]]]
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;No surprises here. Couchpy only gets sent the new revision the doc was changed to. The query server does not need to know anything else.&lt;/p&gt;

&lt;h2 id=&#34;deleting-a-document&#34;&gt;Deleting a Document&lt;/h2&gt;

&lt;p&gt;What about deletes? Now remember in CouchDB, deleting a document does not zero out the content, but rather, it creates a new revision of the document, marking it as &amp;ldquo;deleted&amp;rdquo;.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$ curl -XDELETE http://localhost:5984/test/db13c4d7dbf11110f1eadce071001e87?rev=2-2f95b6ed98722bf4a7d8750faa316313
{&amp;quot;ok&amp;quot;:true,&amp;quot;id&amp;quot;:&amp;quot;db13c4d7dbf11110f1eadce071001e87&amp;quot;,&amp;quot;rev&amp;quot;:&amp;quot;3-0dbaf84cadb9754e6619a10159852d4e&amp;quot;}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Documents marked as deleted won&amp;rsquo;t be returned by any queries. Now let&amp;rsquo;s have a look at how the query server respond to the request. Trigger the view query and observe &lt;code&gt;/tmp/couchpy.log&lt;/code&gt; file.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;[2016-12-06 01:01:59,143] [DEBUG] Processing [u&#39;reset&#39;, {u&#39;timeout&#39;: 5000, u&#39;reduce_limit&#39;: True}]
[2016-12-06 01:01:59,144] [DEBUG] Returning  True
[2016-12-06 01:01:59,144] [DEBUG] Processing [u&#39;add_fun&#39;, u&amp;quot;def map(doc):\n  yield doc.get(&#39;type&#39;, None), None &amp;quot;]
[2016-12-06 01:01:59,144] [DEBUG] Returning  True
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Nothing! That&amp;rsquo;s right, even though the indexer was triggered, no other commands were sent to the query server. Deleted documents only get excluded from the final result, not from the view index file itself. To get rid of the deleted documents from the view, you will have to trigger a &lt;a href=&#34;http://docs.couchdb.org/en/1.6.1/maintenance/compaction.html#views-compaction&#34;&gt;view compaction&lt;/a&gt;.&lt;/p&gt;

&lt;h1 id=&#34;reduce&#34;&gt;Reduce&lt;/h1&gt;

&lt;p&gt;We have been ignoring one important functionality of CouchDB view so far - reduce functions. Reduce functions let you aggregate the mapped data. For example, if we want to sum up the number of docs per type, we will be providing the view a reduce function.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-python&#34;&gt;def reduce(keys, values):
  return len(keys)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Here we&amp;rsquo;re counting the number of keys. Save the reduce function into that view, trigger it with&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$ curl http://localhost:5984/test/_design/byType/_view/byType?group=true
{&amp;quot;rows&amp;quot;:[
{&amp;quot;key&amp;quot;:&amp;quot;bar&amp;quot;,&amp;quot;value&amp;quot;:2},
{&amp;quot;key&amp;quot;:&amp;quot;foo&amp;quot;,&amp;quot;value&amp;quot;:1}
]}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;and observe the output in &lt;code&gt;couchpy.log&lt;/code&gt;:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;[2016-12-06 01:18:55,286] [DEBUG] Processing [u&#39;reset&#39;, {u&#39;timeout&#39;: 5000, u&#39;reduce_limit&#39;: True}]
[2016-12-06 01:18:55,286] [DEBUG] Returning  True
[2016-12-06 01:18:55,286] [DEBUG] Processing [u&#39;add_fun&#39;, u&amp;quot;def map(doc):\n  yield doc.get(&#39;type&#39;, None), None &amp;quot;]
[2016-12-06 01:18:55,286] [DEBUG] Returning  True
[2016-12-06 01:18:55,286] [DEBUG] Processing [u&#39;map_doc&#39;, {u&#39;_rev&#39;: u&#39;1-17ac4eb1776289a8d73ea6990401c56a&#39;, u&#39;_id&#39;: u&#39;db13c4d7dbf11110f1eadce071003893&#39;, u&#39;type&#39;: u&#39;bar&#39;}]
[2016-12-06 01:18:55,286] [DEBUG] Returning  [[[u&#39;bar&#39;, None]]]
[2016-12-06 01:18:55,287] [DEBUG] Processing [u&#39;map_doc&#39;, {u&#39;_rev&#39;: u&#39;1-17ac4eb1776289a8d73ea6990401c56a&#39;, u&#39;_id&#39;: u&#39;db13c4d7dbf11110f1eadce071002ee1&#39;, u&#39;type&#39;: u&#39;bar&#39;}]
[2016-12-06 01:18:55,287] [DEBUG] Returning  [[[u&#39;bar&#39;, None]]]
[2016-12-06 01:18:55,287] [DEBUG] Processing [u&#39;map_doc&#39;, {u&#39;_rev&#39;: u&#39;1-52308d7a89c9fb18c4c4e47d759834ed&#39;, u&#39;_id&#39;: u&#39;db13c4d7dbf11110f1eadce071002546&#39;, u&#39;type&#39;: u&#39;foo&#39;}]
[2016-12-06 01:18:55,287] [DEBUG] Returning  [[[u&#39;foo&#39;, None]]]

[2016-12-06 01:31:51,135] [DEBUG] Processing [u&#39;reset&#39;, {u&#39;timeout&#39;: 5000, u&#39;reduce_limit&#39;: True}]
[2016-12-06 01:31:51,135] [DEBUG] Returning  True
[2016-12-06 01:31:51,135] [DEBUG] Processing [u&#39;reduce&#39;, [u&#39;def reduce(keys, values):\n    return len(keys)&#39;], [[[u&#39;bar&#39;, u&#39;db13c4d7dbf11110f1eadce071003893&#39;], None], [[u&#39;bar&#39;, u&#39;db13c4d7dbf11110f1eadce071002ee1&#39;], None]]]
[2016-12-06 01:31:51,135] [DEBUG] Returning  [True, [2]]
[2016-12-06 01:31:51,136] [DEBUG] Processing [u&#39;reset&#39;, {u&#39;timeout&#39;: 5000, u&#39;reduce_limit&#39;: True}]
[2016-12-06 01:31:51,137] [DEBUG] Returning  True
[2016-12-06 01:31:51,137] [DEBUG] Processing [u&#39;reduce&#39;, [u&#39;def reduce(keys, values):\n    return len(keys)&#39;], [[[u&#39;foo&#39;, u&#39;db13c4d7dbf11110f1eadce071002546&#39;], None]]]
[2016-12-06 01:31:51,137] [DEBUG] Returning  [True, [1]]
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;First you will notice is that since the design document is changed, all documents (changes) are reindexed. If you have a huge database, you may want to think twice before updating a design doc. Better yet, don&amp;rsquo;t ever update the design document, but rather, migrate to a new design document (and finish indexing) and cut over to the new design document.&lt;/p&gt;

&lt;p&gt;Then there are the &lt;code&gt;reduce&lt;/code&gt; commands from CouchDB server to the query server. The reducer is sent with the result of the map function in the forms of &lt;code&gt;keys&lt;/code&gt;, &lt;code&gt;values&lt;/code&gt;. Since we don&amp;rsquo;t emit any values, &lt;code&gt;values&lt;/code&gt; will always be &lt;code&gt;None&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;Now our test database only contains 3 documents. Let&amp;rsquo;s make it more interesting and add a lot more documents in.&lt;/p&gt;

&lt;p&gt;Let&amp;rsquo;s add 100 &lt;code&gt;bar&lt;/code&gt; documents and 100 &lt;code&gt;foo&lt;/code&gt; documents:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;for x in {1..100}; do curl -XPOST -H&amp;quot;Content-Type:application/json&amp;quot; http://localhost:5984/test -d&#39;{&amp;quot;type&amp;quot;: &amp;quot;bar&amp;quot;}&#39;; done
for x in {1..100}; do curl -XPOST -H&amp;quot;Content-Type:application/json&amp;quot; http://localhost:5984/test -d&#39;{&amp;quot;type&amp;quot;: &amp;quot;foo&amp;quot;}&#39;; done
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Let&amp;rsquo;s call the reducer:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ curl http://localhost:5984/test/_design/byType/_view/byType?group=true
{&amp;quot;error&amp;quot;:&amp;quot;os_process_error&amp;quot;,&amp;quot;reason&amp;quot;:&amp;quot;{exit_status,1}&amp;quot;}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Hrmm&amp;hellip; we got an error! Couchpy process crashed. Here&amp;rsquo;s another complaint I have about CouchDB. View errors are very opaque. If you look at CouchDB logs, you will see a huge Erlang stack trace. Not much help there. However, the couchpy log does give us something useful. Maybe the query protocol can be amended to allow query servers to return more descriptive error message and having CouchDB relaying these error messages back to the user?&lt;/p&gt;

&lt;p&gt;Anyhow, the error message we have in the couchpy log are:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;[2016-12-06 01:34:59,213] [DEBUG] Processing [u&#39;rereduce&#39;, [u&#39;def reduce(keys, values):\n    return len(keys)&#39;], [14, 18, 18, 18, 18, 18]]
[2016-12-06 01:34:59,214] [ERROR] Error: object of type &#39;NoneType&#39; has no len()
Traceback (most recent call last):
  File &amp;quot;/usr/local/lib/python2.7/dist-packages/couchdb/view.py&amp;quot;, line 146, in run
    retval = handlers[cmd[0]](*cmd[1:])
  File &amp;quot;/usr/local/lib/python2.7/dist-packages/couchdb/view.py&amp;quot;, line 129, in rereduce
    return reduce(*cmd, **{&#39;rereduce&#39;: True})
  File &amp;quot;/usr/local/lib/python2.7/dist-packages/couchdb/view.py&amp;quot;, line 124, in reduce
    results = function(keys, vals)
  File &amp;quot;&amp;lt;string&amp;gt;&amp;quot;, line 2, in reduce
TypeError: object of type &#39;NoneType&#39; has no len()
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Interesting! The operation that failed was actually &lt;a href=&#34;http://docs.couchdb.org/en/1.6.1/query-server/protocol.html#rereduce&#34;&gt;&lt;code&gt;rereduce&lt;/code&gt;&lt;/a&gt;. &lt;code&gt;Rereduce&lt;/code&gt; is a CouchDB&amp;rsquo;s optimization applied to divide-and-conquer large data sets. During &lt;code&gt;rereduce&lt;/code&gt;, no &lt;code&gt;keys&lt;/code&gt; are sent and only &lt;code&gt;values&lt;/code&gt; are sent with &lt;code&gt;rereduce&lt;/code&gt; flag set to &lt;code&gt;True&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;Let&amp;rsquo;s modify our &lt;code&gt;reduce&lt;/code&gt; function to take this into account.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-python&#34;&gt;def reduce(keys, values, rereduce):
    if rereduce:
        return sum(values)
    return len(keys)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;and trigger the view:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$ curl http://localhost:5984/test/_design/byType/_view/byType?group=true
{&amp;quot;rows&amp;quot;:[
{&amp;quot;key&amp;quot;:&amp;quot;bar&amp;quot;,&amp;quot;value&amp;quot;:102},
{&amp;quot;key&amp;quot;:&amp;quot;foo&amp;quot;,&amp;quot;value&amp;quot;:101}
]}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;That&amp;rsquo;s it! And if we take a look at how CouchDB distributes documents to the reducer:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;[2016-12-06 01:47:16,882] [DEBUG] Processing [u&#39;reset&#39;, {u&#39;timeout&#39;: 5000, u&#39;reduce_limit&#39;: True}]
[2016-12-06 01:47:16,882] [DEBUG] Returning  True
[2016-12-06 01:47:16,882] [DEBUG] Processing [u&#39;reduce&#39;, [u&#39;def reduce(keys, values, rereduce):\n    if rereduce:\n        return sum(values)\n    return len(keys)&#39;], [[[u&#39;bar&#39;, u&#39;db13c4d7dbf11110f1eadce07103bf77&#39;], None], [[u&#39;bar&#39;, u&#39;db13c4d7dbf11110f1eadce07103b6b2&#39;], None], [[u&#39;bar&#39;, u&#39;db13c4d7dbf11110f1eadce07103a903&#39;], None], [[u&#39;bar&#39;, u&#39;db13c4d7dbf11110f1eadce07103a06c&#39;], None], [[u&#39;bar&#39;, u&#39;db13c4d7dbf11110f1eadce071039212&#39;], None], [[u&#39;bar&#39;, u&#39;db13c4d7dbf11110f1eadce071038246&#39;], None], [[u&#39;bar&#39;, u&#39;db13c4d7dbf11110f1eadce0710372d6&#39;], None], [[u&#39;bar&#39;, u&#39;db13c4d7dbf11110f1eadce071036338&#39;], None], [[u&#39;bar&#39;, u&#39;db13c4d7dbf11110f1eadce071035d9e&#39;], None], [[u&#39;bar&#39;, u&#39;db13c4d7dbf11110f1eadce071035735&#39;], None], [[u&#39;bar&#39;, u&#39;db13c4d7dbf11110f1eadce071035594&#39;], None], [[u&#39;bar&#39;, u&#39;db13c4d7dbf11110f1eadce071034722&#39;], None], [[u&#39;bar&#39;, u&#39;db13c4d7dbf11110f1eadce071033ef4&#39;], None], [[u&#39;bar&#39;, u&#39;db13c4d7dbf11110f1eadce071033105&#39;], None], [[u&#39;bar&#39;, u&#39;db13c4d7dbf11110f1eadce071032d0f&#39;], None], [[u&#39;bar&#39;, u&#39;db13c4d7dbf11110f1eadce071031f75&#39;], None], [[u&#39;bar&#39;, u&#39;db13c4d7dbf11110f1eadce071031b47&#39;], None], [[u&#39;bar&#39;, u&#39;db13c4d7dbf11110f1eadce07100b399&#39;], None], [[u&#39;bar&#39;, u&#39;db13c4d7dbf11110f1eadce07100a846&#39;], None], [[u&#39;bar&#39;, u&#39;db13c4d7dbf11110f1eadce07100987c&#39;], None], [[u&#39;bar&#39;, u&#39;db13c4d7dbf11110f1eadce071009107&#39;], None], [[u&#39;bar&#39;, u&#39;db13c4d7dbf11110f1eadce071008240&#39;], None], [[u&#39;bar&#39;, u&#39;db13c4d7dbf11110f1eadce0710080e9&#39;], None], [[u&#39;bar&#39;, u&#39;db13c4d7dbf11110f1eadce071007510&#39;], None], [[u&#39;bar&#39;, u&#39;db13c4d7dbf11110f1eadce071007295&#39;], None], [[u&#39;bar&#39;, u&#39;db13c4d7dbf11110f1eadce071007169&#39;], None], [[u&#39;bar&#39;, u&#39;db13c4d7dbf11110f1eadce071006178&#39;], None], [[u&#39;bar&#39;, u&#39;db13c4d7dbf11110f1eadce07100600b&#39;], None], [[u&#39;bar&#39;, u&#39;db13c4d7dbf11110f1eadce07100591f&#39;], None], [[u&#39;bar&#39;, u&#39;db13c4d7dbf11110f1eadce071004c04&#39;], None], [[u&#39;bar&#39;, u&#39;db13c4d7dbf11110f1eadce07100425a&#39;], None], [[u&#39;bar&#39;, u&#39;db13c4d7dbf11110f1eadce071003aa3&#39;], None], [[u&#39;bar&#39;, u&#39;db13c4d7dbf11110f1eadce071003893&#39;], None], [[u&#39;bar&#39;, u&#39;db13c4d7dbf11110f1eadce071002ee1&#39;], None]]]
[2016-12-06 01:47:16,882] [DEBUG] Returning  [True, [34]]
[2016-12-06 01:47:16,883] [DEBUG] Processing [u&#39;reset&#39;, {u&#39;timeout&#39;: 5000, u&#39;reduce_limit&#39;: True}]
[2016-12-06 01:47:16,883] [DEBUG] Returning  True
[2016-12-06 01:47:16,883] [DEBUG] Processing [u&#39;rereduce&#39;, [u&#39;def reduce(keys, values, rereduce):\n    if rereduce:\n        return sum(values)\n    return len(keys)&#39;], [17, 17, 17, 17, 34]]
[2016-12-06 01:47:16,883] [DEBUG] Returning  [True, [102]]
[2016-12-06 01:47:16,884] [DEBUG] Processing [u&#39;reset&#39;, {u&#39;timeout&#39;: 5000, u&#39;reduce_limit&#39;: True}]
[2016-12-06 01:47:16,884] [DEBUG] Returning  True
[2016-12-06 01:47:16,884] [DEBUG] Processing [u&#39;reduce&#39;, [u&#39;def reduce(keys, values, rereduce):\n    if rereduce:\n        return sum(values)\n    return len(keys)&#39;], [[[u&#39;foo&#39;, u&#39;db13c4d7dbf11110f1eadce07106d438&#39;], None], [[u&#39;foo&#39;, u&#39;db13c4d7dbf11110f1eadce07106ccf4&#39;], None], [[u&#39;foo&#39;, u&#39;db13c4d7dbf11110f1eadce07106bec2&#39;], None], [[u&#39;foo&#39;, u&#39;db13c4d7dbf11110f1eadce07106bcce&#39;], None], [[u&#39;foo&#39;, u&#39;db13c4d7dbf11110f1eadce07106b7ec&#39;], None], [[u&#39;foo&#39;, u&#39;db13c4d7dbf11110f1eadce07106b0d0&#39;], None], [[u&#39;foo&#39;, u&#39;db13c4d7dbf11110f1eadce07106a6d4&#39;], None], [[u&#39;foo&#39;, u&#39;db13c4d7dbf11110f1eadce07106a50b&#39;], None], [[u&#39;foo&#39;, u&#39;db13c4d7dbf11110f1eadce07106a12e&#39;], None], [[u&#39;foo&#39;, u&#39;db13c4d7dbf11110f1eadce0710692e5&#39;], None], [[u&#39;foo&#39;, u&#39;db13c4d7dbf11110f1eadce071068702&#39;], None], [[u&#39;foo&#39;, u&#39;db13c4d7dbf11110f1eadce071067f9c&#39;], None], [[u&#39;foo&#39;, u&#39;db13c4d7dbf11110f1eadce07106780f&#39;], None], [[u&#39;foo&#39;, u&#39;db13c4d7dbf11110f1eadce071066912&#39;], None], [[u&#39;foo&#39;, u&#39;db13c4d7dbf11110f1eadce07106665a&#39;], None], [[u&#39;foo&#39;, u&#39;db13c4d7dbf11110f1eadce071065d4b&#39;], None], [[u&#39;foo&#39;, u&#39;db13c4d7dbf11110f1eadce0710437d2&#39;], None], [[u&#39;foo&#39;, u&#39;db13c4d7dbf11110f1eadce071042cff&#39;], None], [[u&#39;foo&#39;, u&#39;db13c4d7dbf11110f1eadce071042b61&#39;], None], [[u&#39;foo&#39;, u&#39;db13c4d7dbf11110f1eadce071042375&#39;], None], [[u&#39;foo&#39;, u&#39;db13c4d7dbf11110f1eadce071041800&#39;], None], [[u&#39;foo&#39;, u&#39;db13c4d7dbf11110f1eadce07104172e&#39;], None], [[u&#39;foo&#39;, u&#39;db13c4d7dbf11110f1eadce071040aa1&#39;], None], [[u&#39;foo&#39;, u&#39;db13c4d7dbf11110f1eadce0710404f1&#39;], None], [[u&#39;foo&#39;, u&#39;db13c4d7dbf11110f1eadce0710402d4&#39;], None], [[u&#39;foo&#39;, u&#39;db13c4d7dbf11110f1eadce071040234&#39;], None], [[u&#39;foo&#39;, u&#39;db13c4d7dbf11110f1eadce07103f423&#39;], None], [[u&#39;foo&#39;, u&#39;db13c4d7dbf11110f1eadce07103e63a&#39;], None], [[u&#39;foo&#39;, u&#39;db13c4d7dbf11110f1eadce07103d6c0&#39;], None], [[u&#39;foo&#39;, u&#39;db13c4d7dbf11110f1eadce07103c7df&#39;], None], [[u&#39;foo&#39;, u&#39;db13c4d7dbf11110f1eadce07103c6c0&#39;], None], [[u&#39;foo&#39;, u&#39;db13c4d7dbf11110f1eadce07103c183&#39;], None], [[u&#39;foo&#39;, u&#39;db13c4d7dbf11110f1eadce071002546&#39;], None]]]
[2016-12-06 01:47:16,884] [DEBUG] Returning  [True, [33]]
[2016-12-06 01:47:16,885] [DEBUG] Processing [u&#39;reset&#39;, {u&#39;timeout&#39;: 5000, u&#39;reduce_limit&#39;: True}]
[2016-12-06 01:47:16,885] [DEBUG] Returning  True
[2016-12-06 01:47:16,885] [DEBUG] Processing [u&#39;rereduce&#39;, [u&#39;def reduce(keys, values, rereduce):\n    if rereduce:\n        return sum(values)\n    return len(keys)&#39;], [17, 17, 17, 17, 33]]
[2016-12-06 01:47:16,885] [DEBUG] Returning  [True, [101]]
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Because we turned on the &lt;code&gt;group&lt;/code&gt; flag, CouchDB will send the keys of the same group down to the reducer. When the reducer finishes and returns the results, CouchDB further sends the collected results to query server with the &lt;code&gt;rereduce&lt;/code&gt; command to further aggregate the results.&lt;/p&gt;

&lt;p&gt;For more information regarding &lt;code&gt;reduce&lt;/code&gt; vs &lt;code&gt;rereduce&lt;/code&gt;, see &lt;a href=&#34;http://guide.couchdb.org/draft/views.html#reduce&#34;&gt;the section&lt;/a&gt; from CouchDb: The Definitive Guide.&lt;/p&gt;

&lt;h1 id=&#34;conclusion&#34;&gt;Conclusion&lt;/h1&gt;

&lt;p&gt;The CouchDB query protocol is hauntingly simple. It uses JSON for inter-process communication and stdin/stdout as communication channel - very unixy and very easy to understand and to extend. For example, it wouldn&amp;rsquo;t take too long for a seasoned programmer to write a Ruby query server to support Ruby views. However, it may not be the most efficient way to query the document store as we will find out in the next article.&lt;/p&gt;
</description>
    </item>
    
  </channel>
</rss>